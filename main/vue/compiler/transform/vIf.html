<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3.0 æºç è§£è¯»</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/slamdunk-the-vue3/onepunch.jpeg">
    <script src="https://hm.baidu.com/hm.js?4484bd6412288feacc311fd7f2054116"></script>
    <meta name="description" content="Vue3.0 æºç è§£è¯»">
    <link rel="preload" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css" as="style"><link rel="preload" href="/slamdunk-the-vue3/assets/js/app.19f0a9f3.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/2.43eface2.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/14.a192b497.js" as="script"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/10.ce270f70.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/11.1a015dc8.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/12.3286883d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/13.64717b64.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/15.77afe700.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/16.e3742f57.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/17.1e6994cd.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/18.aa67dea2.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/19.6aa0a648.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/20.3f65b4d6.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/21.1c13a471.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/22.931f90d4.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/23.175af59a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/24.f8507621.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/3.350504d2.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/4.ce76527a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/5.8846d71d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/6.04c70b96.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/7.171c11ae.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/8.40d7a914.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/9.a7a94907.js">
    <link rel="stylesheet" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/slamdunk-the-vue3/" class="home-link router-link-active"><!----> <span class="site-name">Vue3.0 æºç è§£è¯»</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 è§£è¯»
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  å…³äºæˆ‘
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 è§£è¯»
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  å…³äºæˆ‘
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å“åº”å¼ç³»ç»Ÿ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/reactivity/effect.html" class="sidebar-link">effect</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/reactive.html" class="sidebar-link">reactive</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/baseHandlers.html" class="sidebar-link">baseHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/collectionHandlers.html" class="sidebar-link">collectionHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/ref.html" class="sidebar-link">ref</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/computed.html" class="sidebar-link">computed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ç¼–è¯‘æ¨¡å—</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/compiler.html" class="sidebar-link">compiler</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/parse.html" class="sidebar-link">parse</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>transform(æ­£åœ¨æ–½å·¥ğŸš§)</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform.html" class="sidebar-link">transform</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vOnce.html" class="sidebar-link">vOnce</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vIf.html" class="active sidebar-link">vIf</a></li></ul></section></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/codegen.html" class="sidebar-link">codegen</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>nodeTransforms ç¬¬äºŒä¸ªå°±æ˜¯ vIf, ä¸è¿‡åœ¨è§£æ vIf ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹ createStructuralDirectiveTransformã€‚</p> <p>æ³¨æ„  v-if å’Œ v-for éƒ½å±äº NodeTransformã€‚</p> <blockquote><p>A structural directive transform is a technically a NodeTransform; Only v-if and v-for fall into this category.</p></blockquote> <p>ä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œåªæœ‰ v-if å’Œ v-for å±äº ç»“æ„åŒ–çš„æŒ‡ä»¤å˜åŒ– structural directive transform ï¼Œæ‰€ä»¥ä¸‹é¢ createStructuralDirectiveTransform è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æ˜æ˜¾åªå±äº è¿™ä¸¤ä¸ªæŒ‡ä»¤è°ƒç”¨çš„ã€‚</p> <p>ç°åœ¨çœ‹çœ‹ createStructuralDirectiveTransformï¼Œ ä¼ å‚ name å’Œ å›è°ƒ fnï¼Œname ä¼šè½¬åŒ–æˆ matches æ–¹æ³•ç”¨äºåŒ¹é…æŒ‡ä»¤ï¼Œå¦‚æœ name æ˜¯å­—ç¬¦ä¸²åˆ™åˆ¤æ–­å…¨ç­‰ï¼Œå¦åˆ™æ­£åˆ™æ ¡éªŒã€‚æ¥ç€è¿”å› NodeTransform å‡½æ•°ï¼Œæ¯•ç«Ÿ createStructuralDirectiveTransform å±äº NodeTransform å·¥å‚ã€‚åœ¨ NodeTransform å‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬å…ˆåˆ¤æ–­ä¼ å…¥çš„èŠ‚ç‚¹ç±»å‹æ˜¯ä¸æ˜¯ NodeTypes.ELEMENTï¼Œæ¥ç€åˆ¤æ–­ tagType å¦‚æœæ˜¯  ElementTypes.TEMPLAT ä¸” ä¸Šé¢æœ‰ v-slot æŒ‡ä»¤ï¼Œä¹Ÿä¸è¿›è¡Œå¤„ç†ã€‚è¿˜è®°å¾—ä»€ä¹ˆæ—¶å€™ tagType ä¸º TEMPLATE å—ï¼Ÿ å°±æ˜¯ tag ä¸ºtemplate ï¼Œä¸”ä¸Šé¢æœ‰ <code>if,else,else-if,for,slot</code> æŒ‡ä»¤æ—¶ï¼Œè¿™é‡Œä¸å¤„ç† v-slot æ˜¯å› ä¸ºå®ƒä¼šè¢«å•ç‹¬å¤„ç†ã€‚æ¥ç€æˆ‘ä»¬å¾ªç¯èŠ‚ç‚¹ä¸Šé¢çš„ prop æ¥å¯»æ‰¾ç¬¦åˆè¦æ±‚çš„æŒ‡ä»¤ï¼Œå¦‚æœç¬¦åˆï¼Œæˆ‘ä»¬ä» prop ä¸Šé¢ç§»é™¤ï¼ŒåŒæ—¶åœ¨ç§»é™¤ä¹‹åæˆ‘ä»¬æ‰è°ƒç”¨ fnï¼Œå°±æ˜¯ä¸ºäº†é¿å…é€’å½’æ­»å¾ªç¯ï¼Œæœ€åä¿å­˜ onExit æ–¹æ³• return å‡ºå»ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStructuralDirectiveTransform</span><span class="token punctuation">(</span>
  <span class="token parameter">name<span class="token operator">:</span> string <span class="token operator">|</span> RegExp<span class="token punctuation">,</span>
  fn<span class="token operator">:</span> StructuralDirectiveTransform</span>
<span class="token punctuation">)</span><span class="token operator">:</span> NodeTransform <span class="token punctuation">{</span>
  <span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n <span class="token operator">===</span> <span class="token function-variable function">name</span>
    <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> name<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> node
      <span class="token comment">// structural directive transforms are not concerned with slots</span>
      <span class="token comment">// as they are handled separately in vSlot.ts</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span> <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>isVSlot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> exitFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> props<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> prop <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// structural directives are removed to avoid infinite recursion</span>
          <span class="token comment">// also we remove them *before* applying so that it can further</span>
          <span class="token comment">// traverse itself in case it moves the node around</span>
          props<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          i<span class="token operator">--</span>
          <span class="token keyword">const</span> onExit <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onExit<span class="token punctuation">)</span> exitFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onExit<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> exitFns
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>ä¸‹é¢æˆ‘ä»¬æ­£å¼çœ‹çœ‹æ€ä¹ˆå¤„ç† vIf æŒ‡ä»¤çš„ã€‚<code>/^(if|else|else-if)$/</code> å°±æ˜¯ç”¨æ¥åŒ¹é… v-if æŒ‡ä»¤çš„ï¼Œæ¥ç€è°ƒç”¨ processIf å»å¤„ç†ï¼Œå…¶ä¸­ processIf åŸºæœ¬ç»§æ‰¿ä¼ å…¥çš„å‚æ•°ï¼Œé™¤äº†å¤šäº†ä¸€ä¸ªå›è°ƒå‡½æ•°ä¹‹å¤–ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°æˆ‘ä»¬è¿Ÿç‚¹è®²è§£ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> transformIf <span class="token operator">=</span> <span class="token function">createStructuralDirectiveTransform</span><span class="token punctuation">(</span>
  <span class="token regex">/^(if|else|else-if)$/</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">processIf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ifNode<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> isRoot</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>processIf é¦–å…ˆçœ‹çœ‹ v-if æŒ‡ä»¤çš„è¡¨è¾¾å¼æ˜¯ä¸æ˜¯ä¸ºç©ºï¼Œé™¤äº† v-else ä»¥å¤–éƒ½ä¸èƒ½ä¸ºç©ºï¼Œå¦‚æœè¡¨è¾¾å¼ä¸ºç©ºï¼Œåˆ›å»ºè¡¨è¾¾å¼ä¸º true çš„ SimpleExpressionï¼ŒåŒæ—¶ä¼šä¸ŠæŠ¥ <code>X_V_IF_NO_EXPRESSION</code> é”™è¯¯ã€‚</p> <p>æ¥ç€å¯¹äºéæµè§ˆå™¨ç¯å¢ƒï¼ŒåŒæ—¶æŒ‡å®šäº†å‰ç¼€ï¼Œè€ŒæŒ‡ä»¤çš„è¡¨è¾¾å¼åˆä¸ä¸ºç©ºçš„ï¼Œä¼šè°ƒç”¨ processExpression è§£æè¡¨è¾¾å¼ï¼Œè¿™å—ä¸å¯¹ processExpression å±•å¼€è®²ï¼Œä¼šåœ¨ transformExpression ä¸€å¹¶è®²è§£ï¼Œä¹‹æ‰€ä»¥ vIf è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œæ˜¯å› ä¸º vIf åœ¨ transformExpression çš„å‰é¢è°ƒç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒtransformExpression æ°¸è¿œåªåœ¨éæµè§ˆå™¨ä¸‹è¿è¡Œï¼Œå› ä¸ºå®ƒä¾èµ– babel å»è§£æ JS ASTã€‚</p> <p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯å…ˆå£°æ˜ name ä¸º if çš„ vIf æŒ‡ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›å» <code>dir.name === 'if'</code> çš„åˆ†æ”¯ã€‚é¦–å…ˆä¼šè°ƒç”¨ createIfBranch åˆ›å»ºåˆ†æ”¯ branchï¼Œç„¶åæ–°å»º type ä¸º NodeTypes.IF çš„ AST èŠ‚ç‚¹ï¼ŒæŠŠæˆ‘ä»¬æ–°å»ºçš„åˆ†æ”¯å¡è¿›å»ï¼ŒåŒæ—¶è°ƒç”¨ <code>context.replaceNode</code> å»æ›¿æ¢å½“å‰çš„èŠ‚ç‚¹ï¼Œæˆ‘æŠŠ replaceNode ä»£ç å¤åˆ¶è¿‡æ¥äº†ï¼Œå°±æ˜¯é€šè¿‡ parentã€childIndex æ›¿æ¢å½“å‰èŠ‚ç‚¹ï¼ŒåŒæ—¶æŠŠ currentNode èµ‹å€¼ä¸ºæ–°çš„èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯æ›¿æ¢äº† ifNode èŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ transform çš„æ—¶å€™ æ¯æ¬¡ nodeTransfs å¾ªç¯åéƒ½è¦é‡æ–°é€šè¿‡ currentNode å»å–å€¼ã€‚æœ€åè°ƒç”¨ processCodegen å»å¤„ç†ï¼ŒprocessCodegen å°±æ˜¯æˆ‘ä»¬è°ƒç”¨ processIf æ—¶ä¼ è¿›æ¥çš„å›è°ƒå‡½æ•°ï¼Œæ³¨æ„å¯¹äº exp ä¸º if æ¥è¯´ï¼Œå›è°ƒæœ€åä¸€ä½ ä¸º trueï¼Œä»£è¡¨æ˜¯ vif æŒ‡ä»¤çš„å¼€å¤´ã€‚</p> <p>æˆ‘ä»¬å…ˆç²—ç•¥è¯´ä¸‹ createIfBranchï¼Œå°±æ˜¯ä¸ºæ¯ä¸ª v-if åˆ›å»º branchï¼Œtype ä¸º IF_BRANCHï¼Œcondition ä¸º v-if çš„ expï¼Œå…¶ä¸­å¯¹äº childrenï¼Œå¦‚æœ tagType ä¸º TEMPLATE çš„ï¼Œå–å®ƒçš„ childrenï¼Œå¦åˆ™å–è‡ªèº«ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// target-agnostic transform used for both Client and SSR</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">processIf</span><span class="token punctuation">(</span>
  node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span>
  dir<span class="token operator">:</span> DirectiveNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext<span class="token punctuation">,</span>
  processCodegen<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    <span class="token parameter">node<span class="token operator">:</span> IfNode<span class="token punctuation">,</span>
    branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
    isRoot<span class="token operator">:</span> boolean</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    dir<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'else'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span>exp <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>exp <span class="token keyword">as</span> SimpleExpressionNode<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> loc <span class="token operator">=</span> dir<span class="token punctuation">.</span>exp <span class="token operator">?</span> dir<span class="token punctuation">.</span>exp<span class="token punctuation">.</span>loc <span class="token operator">:</span> node<span class="token punctuation">.</span>loc
    context<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>
      <span class="token function">createCompilerError</span><span class="token punctuation">(</span>ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_V_IF_NO_EXPRESSION</span><span class="token punctuation">,</span> dir<span class="token punctuation">.</span>loc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    dir<span class="token punctuation">.</span>exp <span class="token operator">=</span> <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">true</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> loc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__BROWSER__ <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>prefixIdentifiers <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// dir.exp can only be simple expression because vIf transform is applied</span>
    <span class="token comment">// before expression transform.</span>
    dir<span class="token punctuation">.</span>exp <span class="token operator">=</span> <span class="token function">processExpression</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>exp <span class="token keyword">as</span> SimpleExpressionNode<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'if'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">createIfBranch</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> dir<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ifNode<span class="token operator">:</span> IfNode <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">,</span>
      branches<span class="token operator">:</span> <span class="token punctuation">[</span>branch<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    context<span class="token punctuation">.</span><span class="token function">replaceNode</span><span class="token punctuation">(</span>ifNode<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>processCodegen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">processCodegen</span><span class="token punctuation">(</span>ifNode<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contex <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">replaceNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>currentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Node being replaced is already removed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot replace root node.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>context<span class="token punctuation">.</span>childIndex<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> node
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createIfBranch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span> dir<span class="token operator">:</span> DirectiveNode</span><span class="token punctuation">)</span><span class="token operator">:</span> IfBranchNode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF_BRANCH</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">,</span>
    condition<span class="token operator">:</span> dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'else'</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> dir<span class="token punctuation">.</span>exp<span class="token punctuation">,</span>
    children<span class="token operator">:</span> node<span class="token punctuation">.</span>tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span> <span class="token operator">?</span> node<span class="token punctuation">.</span>children <span class="token operator">:</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>æˆ‘ä»¬å…ˆå¼€çœ‹çœ‹ processCodegenï¼Œé¦–å…ˆ processCodegen ä¸åšä»€ä¹ˆï¼Œé™¤äº†è¿”å› exitfn å¤–ã€‚ vif çš„ name ä¸º if åœ¨ transform çš„ nodeTransforms ä¹‹åï¼Œé¦–å…ˆä¼šè¢« switch å¤„ç†ï¼Œè¿™æ—¶ä»–é¦–å…ˆä¼šè¢« NodeTypes.IF æ•è·ï¼Œè¿™æ—¶è°ƒç”¨ traverseNode å»éå†ä»–çš„ node.branchesï¼Œç„¶åä»–çš„ branch è¢«éå†çš„æ—¶å€™ï¼Œåˆè¢« IF_BRANCH æ•è·ï¼Œä»è€Œéå†   IF_BRANCH çš„ childrenï¼Œå³åŸæ¥ä¸‹é¢çš„ v-if æŒ‡ä»¤ä¸‹åŸæ¥çš„èŠ‚ç‚¹ã€‚ä»ä¸Šé¢å°±å¯ä»¥çœ‹åˆ°ä¸ºä»€ä¹ˆè¦åœ¨ createStructuralDirectiveTransform ä¸­æŠŠ v-if æŒ‡ä»¤ä» props åˆ é™¤äº†ï¼Œä¸ç„¶é‚£å°±çœŸçš„é€’å½’æ­»å¾ªç¯äº†ã€‚</p> <p>åœ¨ vif å¤„ç†å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬çš„ exitfn å¼€å§‹è¢«è°ƒç”¨ã€‚å¯¹äº isRoot æ¥è¯´ï¼Œé€šè¿‡ createCodegenNodeForBranch å»åˆ›å»º codegenNodeã€‚</p> <p>createCodegenNodeForBranch ä¸­ï¼Œå¯¹äº branch.condition ä¸ä¸ºç©ºçš„ï¼Œåˆ›å»º  createConditionalExpression çš„ AST èŠ‚ç‚¹ã€‚å¯¹äº createConditionalExpression èŠ‚ç‚¹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtest æ˜¯è¡¨ç¤ºåˆ†æ”¯çš„æ¡ä»¶ï¼Œconsequent è¡¨ç¤ºåˆ†æ”¯æ¡ä»¶æˆç«‹æ—¶ï¼Œè¦è¿è¡Œçš„ codeGenNodeï¼Œè¿™é‡Œè°ƒç”¨ createChildrenCodegenNode å»åˆ›å»ºï¼Œè€Œ alternate è¡¨ç¤ºåˆ†æ”¯æ¡ä»¶ä¸æˆç«‹æ—¶ï¼Œè¦è¿è¡Œçš„åˆ†æ”¯ï¼Œé»˜è®¤æ˜¯æ–°å»ºä¸€ä¸ªæ³¨é‡Šï¼Œå› ä¸º if åé¢ä¸ä¸€å®šæœ‰å…¶ä»–åˆ†æ”¯ï¼ŒåŒæ—¶æˆ‘ä»¬ä¸ºäº† vdom  ç»“æ„çš„ç¨³å®šæ€§ã€‚å¦‚æœ if åˆ†æ”¯åé¢è¿˜æœ‰æœ‰å…¶ä»– else-if ã€elseï¼Œalternate ä¼šè¢«è¦†ç›–ã€‚ä»é isRoot å°±å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºå…¶ä»–åˆ†æ”¯ï¼Œé¦–å…ˆæ‹¿åˆ° if åˆ†æ”¯çš„ ASTï¼Œç„¶ååˆ¤æ–­ alternate æ˜¯ä¸æ˜¯ JS_CONDITIONAL_EXPRESSIONï¼Œæˆ‘ä»¬è¦æ‹¿åˆ°æœ€åä¸€ä¸ªä¸æ˜¯ JS_CONDITIONAL_EXPRESSION çš„ ASTï¼Œå³è¿™æ—¶çš„ AST æ˜¯ CallExpression ï¼Œè¿™æ—¶æˆ‘ä»¬é€šè¿‡ createCodegenNodeForBranch å»åˆ›å»º ASTï¼Œä»å¯ä»¥çœ‹åˆ° v-if æŒ‡ä»¤çš„ ASTï¼Œæ˜¯é€šè¿‡ alternate æŠŠæ‰€æœ‰çš„æ¡ä»¶é“¾æ¥èµ·æ¥çš„ï¼Œæœ‰ç‚¹åƒé“¾è¡¨ï¼Œè€Œå¤„äºè¿™ä¸ªé“¾è¡¨æœ€é¡¶ç«¯çš„ï¼Œæ˜¯ name ä¸º if çš„åˆ†æ”¯ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token parameter">ifNode<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> isRoot</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Exit callback. Complete the codegenNode when all children have been</span>
      <span class="token comment">// transformed.</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ifNode<span class="token punctuation">.</span>codegenNode <span class="token operator">=</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
            branch<span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            context
          <span class="token punctuation">)</span> <span class="token keyword">as</span> IfConditionalExpression
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// attach this branch's codegen node to the v-if root.</span>
          <span class="token keyword">let</span> parentCondition <span class="token operator">=</span> ifNode<span class="token punctuation">.</span>codegenNode<span class="token operator">!</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>
            parentCondition<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>type <span class="token operator">===</span>
            NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CONDITIONAL_EXPRESSION</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parentCondition <span class="token operator">=</span> parentCondition<span class="token punctuation">.</span>alternate
          <span class="token punctuation">}</span>
          parentCondition<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
            branch<span class="token punctuation">,</span>
            ifNode<span class="token punctuation">.</span>branches<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
            context
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
  <span class="token parameter">branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span> IfConditionalExpression <span class="token operator">|</span> BlockCodegenNode <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>branch<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createConditionalExpression</span><span class="token punctuation">(</span>
      branch<span class="token punctuation">.</span>condition<span class="token punctuation">,</span>
      <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// make sure to pass in asBlock: true so that the comment node call</span>
      <span class="token comment">// closes the current block.</span>
      <span class="token function">createCallExpression</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        __DEV__ <span class="token operator">?</span> <span class="token string">'&quot;v-if&quot;'</span> <span class="token operator">:</span> <span class="token string">'&quot;&quot;'</span><span class="token punctuation">,</span>
        <span class="token string">'true'</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> IfConditionalExpression
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createConditionalExpression</span><span class="token punctuation">(</span>
  test<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  consequent<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">[</span><span class="token string">'consequent'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  alternate<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">[</span><span class="token string">'alternate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  newline <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ConditionalExpression <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CONDITIONAL_EXPRESSION</span><span class="token punctuation">,</span>
    test<span class="token punctuation">,</span>
    consequent<span class="token punctuation">,</span>
    alternate<span class="token punctuation">,</span>
    newline<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> locStub
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>æˆ‘ä»¬å›åˆ° processIf ä¸­çš„ elseï¼Œå³ name ä¸æ˜¯ if çš„åˆ†æ”¯ï¼Œæˆ‘ä»¬ä»ä¸Šé¢çŸ¥é“å…¶ä»–åˆ†æ”¯éƒ½è¦æŒ‚è½½åˆ° if åˆ†æ”¯ä¸‹é¢ï¼Œé‚£å…·ä½“æ˜¯æ€ä¹ˆæŒ‚è½½çš„å‘¢ï¼Ÿ</p> <p>é¦–å…ˆæ‰¾åˆ°å½“å‰èŠ‚ç‚¹æ‰€æœ‰ç›¸é‚»èŠ‚ç‚¹ï¼Œè¿™ä¸ªé€šè¿‡ parent å»æ‹¿å®ƒçš„ childrenï¼Œç„¶åæ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å‡è®¾å¦‚æœå­˜åœ¨ ifèŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»–ä¸€å®šåœ¨å½“å‰èŠ‚ç‚¹çš„å‰é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾€å‰é¢å¼€å§‹éå†ã€‚é‡åˆ°æ³¨é‡ŠèŠ‚ç‚¹ï¼Œå°±æŠŠä»–ç§»é™¤ï¼ŒåŒæ—¶å¡è¿› commentsã€‚å¦‚æœé‡åˆ°äº† NodeTypes.IF èŠ‚ç‚¹ï¼Œé‚£å°±å¤ªå¥½äº†ï¼Œä»–å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„èŠ‚ç‚¹ã€‚æˆ‘ä»¬é¦–å…ˆæŠŠå½“å‰èŠ‚ç‚¹ä»çˆ¶èŠ‚ç‚¹é‚£é‡Œç§»é™¤æ‰ï¼Œç„¶åç»™å½“å‰èŠ‚ç‚¹åˆ›å»ºåˆ†æ”¯ï¼Œç„¶åå¡åˆ° NodeTypes.IF çš„ branch é‡Œé¢ï¼Œå†è°ƒç”¨ processCodegen ç”Ÿæˆ onExitï¼Œå‰é¢æˆ‘ä»¬çŸ¥é“ï¼Œæ³¨æ„è¿™æ˜¯ processCodegen æœ€åå‚æ•°ä¸º falseï¼Œ ä»–ä¼ å…¥çš„ sibling å°±æ˜¯ é¡¶éƒ¨çš„ if nodeï¼Œè¿™æ ·è®©æˆ‘ä»¬ codegenNode é€šè¿‡ alternate æŠŠä¸åŒåˆ†æ”¯é“¾æ¥èµ·æ¥ã€‚è¿˜æœ‰å°±æ˜¯ï¼Œæˆ‘ä»¬çš„å½“å‰ node è¢«ç§»é™¤äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒåœ¨ nodesTransforms ä¸­çš„å¾ªç¯æå‰ç»ˆæ­¢äº†ï¼Œä½†æ˜¯å®ƒè¿˜æœ‰å…¶ä»–éœ€è¦è½¬åŒ–å•Šï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è°ƒç”¨ traverseNode å»éå†ï¼Œä»–ä¼šè½åˆ° switch ä¸­çš„ IF_BRANCH åˆ†æ”¯ä¸­ã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯å…¶ä»–åˆ†æ”¯ä¸ä¼šè¿”å› exitFnï¼Œå› ä¸ºå¾ªç¯ç»ˆæ­¢äº†ï¼Œå°±ç®—è¿”å›ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ï¼Œæ‰€ä»¥ exitFn ä¹Ÿæ‰‹åŠ¨è°ƒç”¨ã€‚</p> <p>é‚£å¦‚æœæ‰¾ä¸åˆ° if åˆ†æ”¯å‘¢ï¼Ÿ ä¸ŠæŠ¥ <code>ErrorCodes.X_V_ELSE_NO_ADJACENT_IF</code> é”™è¯¯ã€‚è€Œå¯¹äºè¿™ä¸ªå¾ªç¯æ¥è¯´ï¼Œåªè¦å½“å‰èŠ‚ç‚¹å‰é¢çš„èŠ‚ç‚¹ä¸æ˜¯æ³¨é‡Šåˆ†æ”¯ï¼Œéƒ½ä¼šç›´æ¥ breakï¼Œä¹Ÿè®¸ä¼šç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸èƒ½æ˜¯å…¶ä»–åˆ†æ”¯å‘¢ï¼Ÿå…¶ä»–åˆ†æ”¯éƒ½åœ¨å‰é¢ä»çˆ¶èŠ‚ç‚¹ç§»é™¤äº†å•Šã€‚</p> <p>æ³¨æ„å¯¹äºä¸€å¼€å§‹ <code>dir.name === 'if'</code> æ¥è¯´ï¼Œå½“å®ƒå›åˆ° traverseNode æ—¶ï¼Œå®ƒæ˜¯ NodeTypes.IF ç±»å‹ï¼Œç„¶åæˆ‘ä»¬ä¼šéå†å®ƒçš„ branchesï¼Œå…¶å®ä»–çš„branch è¿™æ—¶åªæœ‰ if ä¸€ä¸ªåˆ†æ”¯ï¼Œéå† if åˆ†æ”¯çš„æ—¶å€™ï¼Œåˆæ‰å…¥äº† NodeTypes.IF_BRANCH ä¸­ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// locate the adjacent v-if</span>
    <span class="token keyword">const</span> siblings <span class="token operator">=</span> context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children
    <span class="token keyword">const</span> comments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> siblings<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span> <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sibling <span class="token operator">=</span> siblings<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> sibling <span class="token operator">&amp;&amp;</span> sibling<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">removeNode</span><span class="token punctuation">(</span>sibling<span class="token punctuation">)</span>
        comments<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>sibling<span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sibling <span class="token operator">&amp;&amp;</span> sibling<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// move the node to the if node's branches</span>
        context<span class="token punctuation">.</span><span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">createIfBranch</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> dir<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> comments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          branch<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>comments<span class="token punctuation">,</span> <span class="token operator">...</span>branch<span class="token punctuation">.</span>children<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        sibling<span class="token punctuation">.</span>branches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>branch<span class="token punctuation">)</span>
        <span class="token keyword">const</span> onExit <span class="token operator">=</span> processCodegen <span class="token operator">&amp;&amp;</span> <span class="token function">processCodegen</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token comment">// since the branch was removed, it will not be traversed.</span>
        <span class="token comment">// make sure to traverse here.</span>
        <span class="token function">traverseNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
        <span class="token comment">// call on exit</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onExit<span class="token punctuation">)</span> <span class="token function">onExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// make sure to reset currentNode after traversal to indicate this</span>
        <span class="token comment">// node has been removed.</span>
        context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>
          <span class="token function">createCompilerError</span><span class="token punctuation">(</span>ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_V_ELSE_NO_ADJACENT_IF</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>å¯¹äº vIfï¼Œåªå‰©ä¸‹ createCodegenNodeForBranch è¿˜æ²¡è®²ã€‚æˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ exitFn ä¸Šé¢è°ƒç”¨ï¼Œç”¨äºç”Ÿæˆ codeGenNodeçš„ã€‚ä¸‹é¢æˆ‘ä»¬çŸ¥é“ï¼Œé™¤äº† else åˆ†æ”¯ï¼Œè¿”å›çš„ éƒ½æ˜¯ createConditionalExpressionï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†é“¾æ¥ä¸åŒåˆ†æ”¯ã€‚è€Œä¸ç®¡æ˜¯ä»€ä¹ˆåˆ†æ”¯ï¼Œæœ€ç»ˆçœŸæ­£æ„ä¹‰ä¸Šçš„ codeGenNode éƒ½æ˜¯é€šè¿‡ createChildrenCodegenNode åˆ›å»ºã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
  <span class="token parameter">branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span> IfConditionalExpression <span class="token operator">|</span> BlockCodegenNode <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>branch<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createConditionalExpression</span><span class="token punctuation">(</span>
      branch<span class="token punctuation">.</span>condition<span class="token punctuation">,</span>
      <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// make sure to pass in asBlock: true so that the comment node call</span>
      <span class="token comment">// closes the current block.</span>
      <span class="token function">createCallExpression</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        __DEV__ <span class="token operator">?</span> <span class="token string">'&quot;v-if&quot;'</span> <span class="token operator">:</span> <span class="token string">'&quot;&quot;'</span><span class="token punctuation">,</span>
        <span class="token string">'true'</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> IfConditionalExpression
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>é‚£å°±æ¥çœ‹çœ‹ createChildrenCodegenNodeï¼Œè¿™é‡Œè¯´ç™½äº†å°±æ˜¯ä¸ºäº†å»ºç«‹ Block tree ã€‚é¦–å…ˆæˆ‘ä»¬åˆ›å»º keyProperty ï¼Œç”¨äºä¼˜åŒ–  diffï¼Œä¼šè¢«æ³¨å…¥åˆ°æˆ‘ä»¬ç”Ÿæˆçš„ codeGenNode ä¸­ã€‚æ¥ç€æˆ‘ä»¬æ‹¿å‡ºåˆ†æ”¯ä¸­çš„ç¬¬ä¸€ä¸ªchild firstChildã€‚æˆ‘ä»¬å…ˆåˆ¤æ–­ children éœ€ä¸éœ€è¢« FRAGMENT åŒ…ä½ï¼Œå¦‚æœ children é•¿åº¦ä¸ä¸º 1 æˆ–è€… é•¿åº¦ä¸º1ä½†ç¬¬ä¸€ä¸ªå…ƒç´ ç±»ä¼¼ä¸æ˜¯ NodeTypes.ELEMENT æ—¶ï¼Œå¯èƒ½éœ€è¦ç”¨ FRAGMENT åŒ…ä½ï¼Œæ³¨æ„ patchFlag ä¸º STABLE_FRAGMENTï¼Œdiff æ—¶ è¦ç”¨åˆ°ã€‚ä½†æ˜¯æœ‰ä¸ªä¾‹å¤–ï¼Œå°±æ˜¯åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸”å…ƒç´ æ˜¯ NodeTypes.FOR ç±»å‹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦åŒ…ä½ï¼Œå› ä¸º FOR ç±»å‹æœ¬èº«éƒ½è¦ FRAGMENT åŒ…ä½äº†ã€‚</p> <p>è€Œå¯¹äºä¸éœ€è¦FRAGMENT åŒ…ä½çš„ else åˆ†æ”¯ï¼Œå³chidren é•¿åº¦ä¸º 1 ä¸” type ä¸º NodeTypes.ELEMENTï¼Œæˆ‘ä»¬éœ€è¦å–å‡º firstChild çš„ codegenNodeï¼ŒVNODE_CALL ç±»å‹æ˜¯åœ¨ parseElement æ—¶å€™ç”Ÿæˆçš„ï¼ŒcodegenNode ä¹Ÿæ˜¯é‚£æ—¶å€™ç”Ÿæˆçš„ï¼Œå°±æ˜¯ç”¨äºåˆ›å»º VNode, å¯¹äºç±»å‹æ˜¯ VNODE_CALLï¼Œå¯¹äº tagType æ˜¯ COMPONENT ä¸” tag æ˜¯ TELEPORTã€æˆ–è€…æ ¹æ® parse çš„ç”Ÿæˆçš„ tagType è¿˜å¯èƒ½æ˜¯ slotã€templateã€elementï¼Œéœ€è¦ç”¨ block åŒ…ä½ï¼Œä¼šæ ‡è®° isBlock ä¸º true ï¼ŒåŒæ—¶ä¸º runtime æ³¨å…¥ä¸¤ä¸ªæ–¹æ³•ã€‚tagType æ˜¯ COMPONENT çš„å…¶ä»– Tag é»˜è®¤ isBlock ä¸º true äº†ã€‚è‡³äº block å¹²å˜›ç”¨çš„ï¼Œå°±æ˜¯ç”¨äºåŠ é€Ÿ diff æ—¶ï¼Œå¯¹äºåŠ¨æ€èŠ‚ç‚¹çš„ä¼˜åŒ–ï¼Œå°±æ˜¯ä¼ é—»ä¸­çš„ block treeï¼Œdiff æ—¶åªå¯¹ block éƒ¨åˆ†è¿›è¡Œ diffï¼Œæ¯•ç«Ÿ åŠ¨æ€èŠ‚ç‚¹ä¸­ä¹Ÿæœ‰ä¸å˜çš„éƒ¨åˆ†ï¼Œä½†è¿™éƒ¨åˆ†åˆä¸èƒ½è¢« hoist ä¹Ÿä¸éœ€è¦è¢« diffï¼Œé€šè¿‡ block æˆ‘ä»¬å¯ä»¥è·³è¿‡è¿™éƒ¨åˆ†çš„ diffã€‚</p> <p>æ³¨æ„å¯¹äº createVNodeCall å€’æ•°ç¬¬äºŒä¸ªå‚æ•°ä¸º falseï¼Œè¡¨ç¤ºä¸æ˜¯ isForBlock, å› ä¸º å¯¹äº forBlock æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›ä»–è¢« full diff,å› ä¸ºå¯¹äº forBlock æ¥è¯´ä¸­é—´çš„ child çš„å¾ªåºå¯èƒ½ä¼šæ‰“ä¹±ï¼Œblock tree éœ€è¦é¡ºåºå’Œç»“æ„ç¨³å®šï¼Œè€Œ forBlcok ä¸º trueï¼Œåœ¨ runtime çš„æ—¶å€™ï¼Œä¼šè®© currentBlock ä¸º null çš„ï¼Œä¹Ÿå°±æ˜¯ä»–ä¸ä¼šç›´æ¥æ”¶é›†è‡ªå·±ä¸‹é¢çš„åŠ¨æ€èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ full diff çš„æ—¶å€™ï¼Œæˆ–è®¸ä¸‹é¢æœ‰èŠ‚ç‚¹æœ‰ block tree ï¼Œåªèƒ½åœ¨è¿™æ—¶ä¸‹é¢çš„èŠ‚ç‚¹æ‰èƒ½èµ°å¿«é€Ÿ diff é€šé“ã€‚</p> <p>å¯èƒ½è¿™å—çœ‹çš„æœ‰ç‚¹æ‡µï¼Œä¸»è¦æ˜¯ diff è¿™å—è¿˜æ²¡è®²ï¼Œå¯ä»¥å…ˆçœ‹ç€å…ˆï¼Œåç»­ä¼šè®²åˆ°ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>
  <span class="token parameter">branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span> BlockCodegenNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> helper <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token keyword">const</span> keyProperty <span class="token operator">=</span> <span class="token function">createObjectProperty</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">key</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> branch
  <span class="token keyword">const</span> firstChild <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> needFragmentWrapper <span class="token operator">=</span>
    children<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">||</span> firstChild<span class="token punctuation">.</span>type <span class="token operator">!==</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needFragmentWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> firstChild<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">FOR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// optimize away nested fragments when child is a ForNode</span>
      <span class="token keyword">const</span> vnodeCall <span class="token operator">=</span> firstChild<span class="token punctuation">.</span>codegenNode<span class="token operator">!</span>
      <span class="token function">injectProp</span><span class="token punctuation">(</span>vnodeCall<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
      <span class="token keyword">return</span> vnodeCall
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createVNodeCall</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        <span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">FRAGMENT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createObjectExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>keyProperty<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PatchFlags<span class="token punctuation">.</span><span class="token constant">STABLE_FRAGMENT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> /* </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
          PatchFlagNames<span class="token punctuation">[</span>PatchFlags<span class="token punctuation">.</span><span class="token constant">STABLE_FRAGMENT</span><span class="token punctuation">]</span>
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        branch<span class="token punctuation">.</span>loc
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vnodeCall <span class="token operator">=</span> <span class="token punctuation">(</span>firstChild <span class="token keyword">as</span> ElementNode<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>codegenNode <span class="token keyword">as</span> BlockCodegenNode
    <span class="token comment">// Change createVNode to createBlock.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      vnodeCall<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">VNODE_CALL</span> <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// component vnodes are always tracked and its children are</span>
      <span class="token comment">// compiled into slots so no need to make it a block</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>firstChild <span class="token keyword">as</span> ElementNode<span class="token punctuation">)</span><span class="token punctuation">.</span>tagType <span class="token operator">!==</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">COMPONENT</span> <span class="token operator">||</span>
        <span class="token comment">// teleport has component type but isn't always tracked</span>
        vnodeCall<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TELEPORT</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnodeCall<span class="token punctuation">.</span>isBlock <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">OPEN_BLOCK</span><span class="token punctuation">)</span>
      <span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_BLOCK</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// inject branch key</span>
    <span class="token function">injectProp</span><span class="token punctuation">(</span>vnodeCall<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vnodeCall
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>æ€»ç»“ï¼Œå¯¹äº vIf æ¥è¯´ï¼ŒNodeTypes.IF èŠ‚ç‚¹æ˜¯æ‰€æœ‰åˆ†æ”¯çš„å®¹å™¨ï¼Œé€šè¿‡ branches æŒ‚è½½ç€ä¸åŒçš„åˆ†æ”¯ï¼Œæ¯ä¸ªåˆ†æ”¯å°±æ˜¯ NodeTypes.IF_BRANCHï¼Œæ‰€æœ‰åˆ†æ”¯çš„ codeGenNode éƒ½æ˜¯é€šè¿‡å®¹å™¨ç›¸é“¾æ¥ï¼Œé€šè¿‡ alternate é“¾æ¥åˆ°ä¸‹ä¸€ä¸ª codeGenNodeã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/slamdunk-the-vue3/main/vue/compiler/transform/vOnce.html" class="prev">
        vOnce
      </a></span> <span class="next"><a href="/slamdunk-the-vue3/main/vue/compiler/codegen.html">
        codegen
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/slamdunk-the-vue3/assets/js/app.19f0a9f3.js" defer></script><script src="/slamdunk-the-vue3/assets/js/2.43eface2.js" defer></script><script src="/slamdunk-the-vue3/assets/js/14.a192b497.js" defer></script>
  </body>
</html>
