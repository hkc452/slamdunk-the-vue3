<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3.0 æºç è§£è¯»</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/slamdunk-the-vue3/onepunch.jpeg">
    <script src="https://hm.baidu.com/hm.js?4484bd6412288feacc311fd7f2054116"></script>
    <meta name="description" content="Vue3.0 æºç è§£è¯»">
    <link rel="preload" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css" as="style"><link rel="preload" href="/slamdunk-the-vue3/assets/js/app.fa9660a2.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/2.43eface2.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/12.226cd84d.js" as="script"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/10.ce270f70.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/11.1a015dc8.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/13.501f5dc8.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/14.5385cb61.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/15.746bc25e.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/16.913a03fb.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/17.3e84bfb4.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/18.2e25ccd6.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/19.8ae9bd7e.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/20.a46bd120.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/21.28065e21.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/22.1d209a45.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/3.42ea3513.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/4.ce76527a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/5.8846d71d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/6.badd6dc3.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/7.171c11ae.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/8.40d7a914.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/9.a7a94907.js">
    <link rel="stylesheet" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/slamdunk-the-vue3/" class="home-link router-link-active"><!----> <span class="site-name">Vue3.0 æºç è§£è¯»</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 è§£è¯»
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  å…³äºæˆ‘
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 è§£è¯»
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  å…³äºæˆ‘
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å“åº”å¼ç³»ç»Ÿ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/reactivity/effect.html" class="sidebar-link">effect</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/reactive.html" class="sidebar-link">reactive</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/baseHandlers.html" class="sidebar-link">baseHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/collectionHandlers.html" class="sidebar-link">collectionHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/ref.html" class="sidebar-link">ref</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/computed.html" class="sidebar-link">computed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ç¼–è¯‘æ¨¡å—</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/compiler.html" class="sidebar-link">compiler</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/parse.html" class="active sidebar-link">parse</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform.html" class="sidebar-link">transform(å‡†å¤‡å¼€å§‹æ–½å·¥ğŸš§)</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/codegen.html" class="sidebar-link">codegen</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>è¿™é‡Œä¸»è¦è®²è®² parse ï¼Œçœ‹çœ‹ Vue æ€ä¹ˆå¯¹æ¨¡æ¿è¿›è¡Œåˆæ­¥çš„è§£æã€‚ åœ¨ compile ä¸­è°ƒç”¨ baseParse è¿›è¡Œ parseï¼Œæ‰€ä»¥è¿™é‡Œå…ˆçœ‹çœ‹ baseParse ã€‚</p> <p>åœ¨è§£æä¹‹å‰ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œç”¨äºä¿å­˜å½“å‰è§£æè¿›åº¦å’Œä¸€äº›é…ç½®é¡¹ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>
  <span class="token parameter">content<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> ParserOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>
    <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>options ä¸­åŸºæœ¬æ˜¯ç”¨ parseOptions ä¼ ä¸‹æ¥çš„ options è¿›è¡Œè¦†ç›–ï¼Œ column è¡¨ç¤ºç¬¬å‡ è¡Œï¼Œ line è¡¨ç¤ºç¬¬å‡ åˆ—ï¼Œ offset è¡¨ç¤ºä¼ å…¥ content çš„åå·®ï¼ŒoriginalSource è¡¨ç¤ºåŸå§‹å­—ç¬¦ä¸²ï¼Œåœ¨ parse ä¸ä¼šè¢«ä¿®æ”¹ï¼Œsource ä¸€å¼€å§‹ä»£è¡¨åŸå§‹å­—ç¬¦ä¸²ï¼Œåœ¨ parse è¿‡ç¨‹ä¼šè¢«è£å‰ªï¼Œ inPre è¡¨ç¤ºæ˜¯å¦åœ¨ pre æ ‡ç­¾é‡Œé¢ï¼ŒinVPre è¡¨ç¤ºæ˜¯å¦åœ¨ VPre æ ‡ç­¾é‡Œé¢ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>
  <span class="token parameter">content<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> ParserOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ParserContext <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>defaultParserOptions<span class="token punctuation">,</span>
      <span class="token operator">...</span>options
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    originalSource<span class="token operator">:</span> content<span class="token punctuation">,</span>
    source<span class="token operator">:</span> content<span class="token punctuation">,</span>
    inPre<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    inVPre<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>å›åˆ° baseParseï¼Œåˆ›å»ºå®Œ context ä¹‹åï¼Œæˆ‘ä»¬é¦–å…ˆè·å–ä¸€å¼€å§‹çš„å­—ç¬¦ä¸²çš„åæ ‡ã€‚ getCursor è¿”å›å½“å‰çš„ è¡Œã€åˆ—ã€åå·®ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getCursor</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ParserContext</span><span class="token punctuation">)</span><span class="token operator">:</span> Position <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> column<span class="token punctuation">,</span> line<span class="token punctuation">,</span> offset <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token keyword">return</span> <span class="token punctuation">{</span> column<span class="token punctuation">,</span> line<span class="token punctuation">,</span> offset <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ç„¶ååœ¨è°ƒç”¨ createRoot è¿”å›æ ¹èŠ‚ç‚¹çš„ ast ä¹‹å‰ï¼Œä½¿ç”¨ parseChildren å¯¹æ¨¡æ¿è¿›è¡Œè§£æã€‚ä¸€å¼€å§‹çš„ TextModes ä¸ºDATAï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ compiler é‡Œé¢æ›¾ç»è¯´è¿‡ï¼Œä¸åŒçš„ TextModes ä¼šå½±å“è§£æã€‚ ä»ä¸‹é¢å¯ä»¥çœ‹å‡ºï¼ŒDATA å¯ä»¥åŒ…å« Elementsã€ Entities ï¼Œç»“æŸçš„æ ‡å¿—æ˜¯åœ¨ tags æ ˆä¸­æ‰¾åˆ° å…³é—­ tagï¼Œè€Œå¯¹äº RCDATAï¼Œä¸åŒ…å«  Elementsï¼ŒåŒ…å«Entitiesï¼Œ ç»“æŸçš„æ ‡å¿—æ˜¯ tags æ ˆä¸Šä¸€çº§æœ‰å…³é—­ tagï¼Œ ä¸€èˆ¬å¤„äº textareaï¼ŒRAWTEXT ä¸åŒ…å«  Elements å’ŒEntitiesï¼Œç»“æŸçš„æ ‡å¿—é¡µæ•°æ˜¯ tags æ ˆä¸Šä¸€çº§æœ‰å…³é—­ tagï¼Œä¸€èˆ¬ä½äº style å’Œ script å†…ã€‚å¯èƒ½åœ¨è¿™é‡Œå•ç‹¬è®²æ¦‚å¿µæœ‰ç‚¹æ‡µï¼Œåé¢ç»“åˆè§£æè¿‡ç¨‹æ¥ä¼šåŠ æ·±ç†è§£ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TextModes <span class="token punctuation">{</span>
  <span class="token comment">//          | Elements | Entities | End sign              | Inside of</span>
  <span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token comment">//    | âœ”        | âœ”        | End tags of ancestors |</span>
  <span class="token constant">RCDATA</span><span class="token punctuation">,</span> <span class="token comment">//  | âœ˜        | âœ”        | End tag of the parent | &lt;textarea&gt;</span>
  <span class="token constant">RAWTEXT</span><span class="token punctuation">,</span> <span class="token comment">// | âœ˜        | âœ˜        | End tag of the parent | &lt;style&gt;,&lt;script&gt;</span>
  <span class="token constant">CDATA</span><span class="token punctuation">,</span>
  <span class="token constant">ATTRIBUTE_VALUE</span>
<span class="token punctuation">}</span>
<span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº Dom å¹³å°æ¥è¯´ï¼Œå¯¹äº DOMNamespaces.HTML,åŒ…æ‹¬åœ¨ iframe å’Œ noscript æ ‡ç­¾é‡Œé¢ï¼ŒRCDATA è¿˜åŒ…æ‹¬ titleã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> isRawTextContainer <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>
  <span class="token string">'style,iframe,script,noscript'</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span>
<span class="token function">getTextMode</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tag<span class="token punctuation">,</span> ns <span class="token punctuation">}</span><span class="token operator">:</span> ElementNode<span class="token punctuation">)</span><span class="token operator">:</span> TextModes <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">===</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'textarea'</span> <span class="token operator">||</span> tag <span class="token operator">===</span> <span class="token string">'title'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRawTextContainer</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>ç°åœ¨è¿›è¡Œ parseChildren çš„åˆ†æã€‚é¦–å…ˆè·å–çˆ¶çº§ ä»¥åŠ çˆ¶çº§çš„Namespacesï¼Œnodes æ˜¯è§£æåçš„ AST èŠ‚ç‚¹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ª while å¾ªç¯åˆ¤æ–­æ˜¯å¦è§£æç»“æŸäº†ï¼ŒåŒæ—¶ä¼š ä¼ å…¥å» modeã€ancestorsï¼Œå¯¹äºæ ¹èŠ‚ç‚¹æ¥è¯´ï¼Œancestors ä¸€å¼€å§‹ä¸ºç©ºæ•°ç»„ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes<span class="token punctuation">,</span>
  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span>
  <span class="token keyword">const</span> ns <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>ns <span class="token operator">:</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span>
  <span class="token keyword">const</span> nodes<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Whitespace management for more efficient output</span>
  <span class="token comment">// (same as v2 whitespace: 'condense')</span>
  <span class="token keyword">let</span> removedWhitespace <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!==</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> removedWhitespace <span class="token operator">?</span> nodes<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> <span class="token operator">:</span> nodes
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>isEnd ç”¨äºåˆ¤æ–­æ˜¯å¦åº”è¯¥è¦ç»“æŸè§£æï¼Œä½†æ˜¯ä¸åŒ TextMode ä¸‹ï¼Œå¯¹ end çš„åˆ¤æ–­æ˜¯ä¸åŒçš„ï¼Œå…¶å®è¿™ç‚¹åœ¨ä¸Šé¢è®² TextModes çš„æ—¶å€™å·²ç»è®²äº†ï¼ŒTextModes.DATA å…è®¸æœ‰æ ‡ç­¾æ²¡é—­åˆï¼Œæ‰€ä»¥åªè¦ç¥–å…ˆæœ‰ç›¸åŒçš„æ ‡ç­¾å°±å¯ä»¥äº†ï¼Œè€Œ RCDATAã€RAWTEXT è¦æ±‚çˆ¶çº§æ ‡ç­¾è·Ÿé—­åˆæ ‡ç­¾ä¸€æ ·æ‰ç®—ç»“æŸï¼Œè€Œå¯¹äº TextModes.CDATA ï¼Œåˆ™è¦æ±‚ <code>]]&gt;</code> ç»“å°¾ï¼Œå¦‚æœéƒ½ä¸ç¬¦åˆè¿™äº›æ¡ä»¶ï¼Œåˆ™çœ‹çœ‹ s æ˜¯å¦ä¸ºç©ºæ¥å†³å®šæ˜¯å¦åˆ°å°½å¤´äº†ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isEnd</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes<span class="token punctuation">,</span>
  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//TODO: probably bad performance</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> ancestors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> ancestors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>

    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token operator">:</span>
    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">']]&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">!</span>s
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>å›åˆ° while å¾ªç¯ï¼Œå¦‚æœ isEnd ä¸º falseï¼Œ è¿›å…¥å¾ªç¯ï¼Œå¦‚æœ mode ä¸º <code>mode === TextModes.DATA || mode === TextModes.RCDATA</code> åˆ™è¿›å…¥ if é‡Œé¢ï¼Œå¦è€…å¾€ä¸‹èµ°ï¼Œå¦‚æœè¿™æ—¶ node è¿˜ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿›è¡Œ parseText æ“ä½œã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>__TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source
<span class="token keyword">let</span> node<span class="token operator">:</span> TemplateChildNode <span class="token operator">|</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>parseText, çœ‹åå­—å°±çŸ¥é“ç”¨æ¥å¹²å˜›çš„ï¼Œé¦–å…ˆåˆ©ç”¨ endTokens å»åˆ¤æ–­ç»“å°¾ï¼Œåˆ†åˆ«æ˜¯æ ‡ç­¾çš„å¼€å¤´ã€å·¦delimitersï¼Œ å¦‚æœæ˜¯ TextModes.CDATA æ¨¡å¼ä¸‹ï¼Œè¿˜åŒ…æ‹¬ <code>]]&gt;</code>ï¼Œ æˆ‘ä»¬éœ€è¦æœ€å°çš„ endIndexï¼Œå³å°½å¯èƒ½çŸ­çš„ Textï¼Œæ¥ç€ä½¿ç”¨ parseTextData å¯¹å†…å®¹è§£æã€‚</p> <p>parseTextData é¦–å…ˆ slice source å¾—åˆ° rawtextï¼Œç„¶å advanceBy è®© context ä¸­ columinã€ line å¾€å‰è¿›åŒæ—¶å¯¹ context.source è¿›è¡Œåˆ‡å‰²ã€‚æ¥ä¸‹æ¥çš„åˆ¤æ–­ï¼Œå°±æ˜¯å†³å®šè¦ä¸è¦å¯¹ Entities è¿›è¡Œè§£ç ï¼Œå¯¹äº <code>mode === TextModes.RAWTEXT || mode === TextModes.CDATA</code> è¿™ä¸¤ç§ä¸éœ€è¦è§£ç ï¼Œè€Œå¦‚æœæ˜¯å…¶ä»–æ¨¡å¼ï¼Œä½†æ˜¯é‡Œé¢æ²¡æœ‰ <code>&amp;</code>ï¼Œ ä¹Ÿä¸éœ€è¦è§£ç ï¼Œå¦åˆ™è°ƒç”¨ä¼ è¿›æ¥çš„è§£ç å‡½æ•°è¿›è¡Œè§£ç ã€‚</p> <p>parseTextData ç»“æŸåï¼Œè¿”å› AST èŠ‚ç‚¹ï¼Œå…¶ä¸­ç±»å‹ä¸º NodeTypes.TEXTï¼Œ å†…å®¹ä¸º parseTextData è¿”å›çš„å†…å®¹ï¼Œloc ä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ä»¥åŠåŸå§‹å†…å®¹ï¼Œå…¶ä¸­ä½ç½®ç”¨ä¸‰ä¸ªç»´åº¦å»è¡¨ç¤º è¡Œã€åˆ—ã€åç§»ï¼Œéœ€è¦è®°ä½çš„æ˜¯ï¼Œç»“æŸä½ç½®æ˜¯å¼€åŒºé—´ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span> mode<span class="token operator">:</span> TextModes</span><span class="token punctuation">)</span><span class="token operator">:</span> TextNode <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> endTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">']]&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endTokens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>endTokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> endIndex <span class="token operator">&gt;</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      endIndex <span class="token operator">=</span> index
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>endIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  length<span class="token operator">:</span> number<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawText <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span> <span class="token operator">||</span>
    mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span> <span class="token operator">||</span>
    rawText<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rawText
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// DATA or RCDATA containing &quot;&amp;&quot;&quot;. Entity decoding required.</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">decodeEntities</span><span class="token punctuation">(</span>
      rawText<span class="token punctuation">,</span>
      mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>å›åˆ°ä¸Šé¢çš„åˆ¤æ–­ï¼Œå¯¹äº <code>mode === TextModes.DATA || mode === TextModes.RCDATA</code> æ¨¡å¼ä¸‹ï¼Œè®°ä½æ ¹èŠ‚ç‚¹æ˜¯ TextModes.DATA æ¨¡å¼ï¼Œç»§ç»­åˆ¤æ–­ï¼Œå¦‚æœä¸åœ¨ inVPre ä¸‹é¢ï¼Œåˆæ˜¯å·¦ delimiters å¼€å¤´çš„ï¼Œå¯¹äºé»˜è®¤ delimiters å¯¹æ˜¯ <code>{{</code> å’Œ <code>}}</code>ï¼Œè¿™äº›éƒ½æ»¡è¶³ï¼Œåˆ™è¿›è¡Œæ’å€¼ parseInterpolation çš„è§£æã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// '{{'</span>
        node <span class="token operator">=</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>parseInterpolation æ’å€¼å‡½æ•°å¦‚ä¸‹ï¼Œæ‹¿åˆ°ç•Œå®šç¬¦ï¼Œåˆ¤æ–­æœ‰æ²¡æœ‰ç»“æŸç•Œå®šç¬¦ï¼Œæ²¡æœ‰çš„è¯ï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œè¿”å› undefined ï¼Œè¿™æ ·åç»­å¯ä»¥è¢«ä¸Šé¢è§£è¯»çš„ parseText è¿›è¡Œå¤„ç†ã€‚start æ˜¯æ’å€¼ç¬¦çš„å¼€å§‹ä½ç½®ï¼Œ innerStart æ˜¯ æ’å€¼å†…å®¹å¼€å§‹çš„ä½ç½®ï¼Œè¿™ä¸ªä¼šè¢«è¿›è¡ŒäºŒæ¬¡ä¿®å¤ï¼Œå› ä¸ºå†…å®¹å‰é¢å¯èƒ½ä¼šæœ‰ç©ºæ ¼ï¼ŒåŒæ · innerEnd æ˜¯æŒ‡æ’å€¼å†…å®¹ç»“æŸçš„ä½ç½®ï¼Œä¹Ÿä¼šè¢«äºŒæ¬¡ä¿®å¤ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆ <code>const endOffset = rawContentLength - (preTrimContent.length - content.length - startOffset)</code> è¿™æ ·ç®—å‘¢ï¼Ÿ</p> <p>é¦–å…ˆ rawContentLength æ˜¯åŸå§‹æ’å€¼çš„é•¿åº¦ï¼Œé‡Œé¢å¯èƒ½åŒ…å«å‰åç©ºæ ¼ä»¥åŠå†…å®¹å¯èƒ½éœ€è¦è§£ç ï¼Œå¦‚æœéœ€è¦è§£ç ï¼Œè§£ç åçš„å†…å®¹æ˜¯æ¯”æ²¡æœ‰è§£ç å‰çš„å†…å®¹é•¿åº¦è¦çŸ­çš„ï¼Œ<code>(preTrimContent.length - content.length - startOffset)</code> æ‹¿åˆ°çš„æ˜¯å†…å®¹åé¢ç©ºæ ¼çš„é•¿åº¦ï¼Œæ‰€ä»¥ endOffset å°±æ˜¯åŸå§‹æ’å€¼å‡å»åé¢ç©ºæ ¼çš„é•¿åº¦ï¼Œä¿®å¤ innerEnd ä¹‹åï¼Œç»§ç»­æŠŠ context æ¨å‘å‰ close çš„é•¿åº¦ï¼Œæœ€åè¿”å›èŠ‚ç‚¹ç±»å‹ä¸º NodeTypes.INTERPOLATIONï¼Œcontent ä¸º NodeTypes.SIMPLE_EXPRESSION ç±»å‹ï¼Œå…¶ä¸­ isConstant ä¼šåœ¨ transformExpression çœŸæ­£ç¡®å®šä¸‹æ¥ï¼Œè¿™é‡Œé»˜è®¤ä¸º falseã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes</span>
<span class="token punctuation">)</span><span class="token operator">:</span> InterpolationNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>open<span class="token punctuation">,</span> close<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> open<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span> open<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_INTERPOLATION_END</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> open<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">const</span> innerStart <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> innerEnd <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> rawContentLength <span class="token operator">=</span> closeIndex <span class="token operator">-</span> open<span class="token punctuation">.</span>length
  <span class="token keyword">const</span> rawContent <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rawContentLength<span class="token punctuation">)</span>
  <span class="token keyword">const</span> preTrimContent <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> rawContentLength<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> preTrimContent<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> startOffset <span class="token operator">=</span> preTrimContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>startOffset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>innerStart<span class="token punctuation">,</span> rawContent<span class="token punctuation">,</span> startOffset<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span>  <span class="token operator">=</span>
    rawContentLength <span class="token operator">-</span> <span class="token punctuation">(</span>preTrimContent<span class="token punctuation">.</span>length <span class="token operator">-</span> content<span class="token punctuation">.</span>length <span class="token operator">-</span> startOffset<span class="token punctuation">)</span>
  <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>innerEnd<span class="token punctuation">,</span> rawContent<span class="token punctuation">,</span> endOffset<span class="token punctuation">)</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> close<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">// Set `isConstant` to false by default and will decide in transformExpression</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      content<span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> innerStart<span class="token punctuation">,</span> innerEnd<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>å›åˆ°å¾ªç¯ï¼Œå¦‚æœä¸æ˜¯æ’å€¼ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å¤„äº TextModes.DATA æ¨¡å¼ï¼Œä»¥åŠç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸æ˜¯ '&lt;'ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåªè¦æ²¡æœ‰è‡ªå®šä¹‰çš„ onError ä¸æ˜¯æŠ›å‡ºé”™è¯¯çš„è¯ï¼Œæœ€åçš„éƒ½ä¼šè¢« parseText å…œåº•å¤„ç†çš„ã€‚</p> <p>ä¸‹é¢ç»§ç»­çœ‹ï¼Œå¦‚æœ  <code>s.length === 1</code> åˆ™ ä¸ŠæŠ¥é”™è¯¯ï¼Œå¦åˆ™å¦‚æœçœ‹çœ‹å­—ç¬¦ä¸²ç¬¬äºŒä½æ˜¯ä¸æ˜¯ <code>!</code>ï¼Œå› ä¸ºæœ‰å¯èƒ½æ˜¯ html æ³¨è§£<code>&lt;!--</code>ï¼Œ ä¹Ÿæœ‰å¯èƒ½æ˜¯ DOCTYPE <code>&lt;!DOCTYPE</code>,  å¦‚æœæ˜¯ <code>&lt;![CDATA[</code> å¼€å¤´ä¸” ä¸æ˜¯å‡ºäº Namespaces.HTML å‘½åç©ºé—´ä¸‹çš„è¯ï¼Œåˆ™ç”¨ parseCDATA è§£æï¼Œå¦åˆ™ä¸ŠæŠ¥ <code>CDATA_IN_HTML_CONTENT</code> é”™è¯¯ï¼Œå¦‚æœ <code>!</code> éƒ½æ²¡æœ‰è¢«å¤„ç†çš„è¯ï¼Œä¸ŠæŠ¥ <code>INCORRECTLY_OPENED_COMMENT</code> é”™è¯¯ï¼Œä¸Šé¢ä¸¤ä¸ªé”™è¯¯éƒ½ç”¨ parseBogusComment å…œåº•å¤„ç† å¦‚æœä¸ŠæŠ¥æ²¡æœ‰æŠ›å‡ºé”™è¯¯çš„è¯ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// https://html.spec.whatwg.org/multipage/parsing.html#tag-open-state</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_BEFORE_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// https://html.spec.whatwg.org/multipage/parsing.html#markup-declaration-open-state</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;!--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node <span class="token operator">=</span> <span class="token function">parseComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;!DOCTYPE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Ignore DOCTYPE by a limitation.</span>
        node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;![CDATA['</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">!==</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node <span class="token operator">=</span> <span class="token function">parseCDATA</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">CDATA_IN_HTML_CONTENT</span><span class="token punctuation">)</span>
          node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INCORRECTLY_OPENED_COMMENT</span><span class="token punctuation">)</span>
        node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>æ¥ä¸‹æ¥ï¼Œå…ˆè®²è®² <code>!</code> å¼€å¤´ç”¨åˆ°çš„å‡ ä¸ªè§£æå‡½æ•°ï¼ŒparseComment ã€parseBogusComment å’Œ parseCDATAã€‚</p> <p>å…ˆçœ‹çœ‹ parseCommentï¼Œ å…ˆæ–­è¨€æ˜¯å¦ç¬¦åˆæ³¨é‡Šï¼Œæ¥ç€ç”¨æ­£åˆ™åŒ¹é…æ³¨é‡Šçš„ç»“å°¾ï¼Œå¦‚æœåŒ¹é…ä¸åˆ°ï¼Œåˆ™æ¶ˆè´¹å®Œå‰©ä¸‹çš„sourceï¼ŒåŒæ—¶ä¸ŠæŠ¥ <code>EOF_IN_COMMENT</code> é”™è¯¯ã€‚å¦‚æœ <code>match.index &lt;= 3</code>, è¯´æ˜åŒ¹é…åˆ°çš„ <code>--</code> æ˜¯æ³¨é‡Šå¼€å¤´çš„ <code>--</code>, ä¸ŠæŠ¥<code>ABRUPT_CLOSING_OF_EMPTY_COMMENT</code>,å¦‚æœåˆ†ç»„1æœ‰æœ‰å€¼ï¼Œä¸ŠæŠ¥ <code>INCORRECTLY_CLOSED_COMMENT</code>,æ³¨é‡Šç»“å°¾ä¸å…è®¸æœ‰æ„Ÿå¹å·ã€‚æ¥ç€åˆ¤æ–­æ³¨é‡Šé‡Œé¢æœ‰æ²¡æœ‰åµŒå¥—æ³¨é‡Šï¼Œæœ‰çš„è¯ï¼Œä¹Ÿè¦ä¸ŠæŠ¥ <code>NESTED_COMMENT</code>ï¼Œè‡³äº<code>advanceBy(context, nestedIndex - prevIndex + 1)</code> ä¸ºä»€ä¹ˆè¦åŠ 1å‘¢ï¼Œå› ä¸º prevIndex æ˜¯ context ä¸­ä½ç½®çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¿®å¤æ­£ç¡®çš„é•¿åº¦è¦åŠ 1ã€‚æœ€åè¿”å› type ä¸º NodeTypes.COMMENTï¼Œ content ä¸ºæ³¨é‡Šå†…å®¹çš„ AST èŠ‚ç‚¹ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseComment</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ParserContext</span><span class="token punctuation">)</span><span class="token operator">:</span> CommentNode <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'&lt;!--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">let</span> content<span class="token operator">:</span> string

  <span class="token comment">// Regular comment.</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/--(\!)?&gt;/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_COMMENT</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">.</span>index <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">ABRUPT_CLOSING_OF_EMPTY_COMMENT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INCORRECTLY_CLOSED_COMMENT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> match<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

    <span class="token comment">// Advancing with reporting nested comments.</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> match<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
    <span class="token keyword">let</span> prevIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
      nestedIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nestedIndex <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;!--'</span><span class="token punctuation">,</span> prevIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> nestedIndex <span class="token operator">-</span> prevIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nestedIndex <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">NESTED_COMMENT</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      prevIndex <span class="token operator">=</span> nestedIndex <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">.</span>index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> prevIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
    content<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>å†çœ‹çœ‹ parseBogusCommentï¼Œä¹Ÿæ˜¯ä¸€å¼€å§‹ç”¨æ­£åˆ™å»åˆ¤æ–­å¼€å¤´æ˜¯å¦ç¬¦åˆï¼Œè¿™ä¸ªæ­£åˆ™æœ‰ç‚¹æ„æ€ï¼Œå°±æ˜¯å¼€å¤´<code>&lt;</code>, ä¸­é—´æˆ–è€…æ˜¯ <code>!</code> æˆ–è€… <code>?</code> æˆ–è€…æ˜¯ <code>/</code> åé¢è·Ÿç€ä¸æ˜¯ a åˆ° zã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ParserContext</span><span class="token punctuation">)</span><span class="token operator">:</span> CommentNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token regex">/^&lt;(?:[\!\?]|\/[^a-z&gt;])/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> contentStart <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'?'</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span>
  <span class="token keyword">let</span> content<span class="token operator">:</span> string

  <span class="token keyword">const</span> closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>contentStart<span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>contentStart<span class="token punctuation">,</span> closeIndex<span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> closeIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
    content<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>æˆ‘ä»¬å¯ä»¥å¾ªç¯é‚£é‡Œçœ‹çœ‹ bogusComment çš„é€‚ç”¨èŒƒå›´ã€‚DOCTYPE ã€CDATA åœ¨ Namespaces.HTML å‘½åç©ºé—´æ—¶ã€<code>&lt;ï¼</code>å¼€å¤´çš„å…œåº•ã€s[1] ä¸º <code>/</code> ä¸” s[2] ä¸ä¸º <code>[a-z]</code>, <code>&lt;?</code>å¼€å¤´çš„ã€‚è¿™ä¹ˆä¸€è§£é‡Šï¼Œæ˜¯ä¸æ˜¯ä¸Šé¢çš„æ­£åˆ™å°±å¥½ç†è§£äº†ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// https://html.spec.whatwg.org/multipage/parsing.html#markup-declaration-open-state</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;!--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node <span class="token operator">=</span> <span class="token function">parseComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;!DOCTYPE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ignore DOCTYPE by a limitation.</span>
    node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;![CDATA['</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">!==</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node <span class="token operator">=</span> <span class="token function">parseCDATA</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">CDATA_IN_HTML_CONTENT</span><span class="token punctuation">)</span>
      node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INCORRECTLY_OPENED_COMMENT</span><span class="token punctuation">)</span>
    node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// https://html.spec.whatwg.org/multipage/parsing.html#end-tag-open-state</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_BEFORE_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&gt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">MISSING_END_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_INVALID_END_TAG</span><span class="token punctuation">)</span>
    <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>
      context<span class="token punctuation">,</span>
      ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">,</span>
      <span class="token number">2</span>
    <span class="token punctuation">)</span>
    node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node <span class="token operator">=</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>
    context<span class="token punctuation">,</span>
    ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME</span><span class="token punctuation">,</span>
    <span class="token number">1</span>
  <span class="token punctuation">)</span>
  node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>é‚£æˆ‘ä»¬å›åˆ° parseBogusComment ç»§ç»­è®²è§£ã€‚å¯¹äº <code>context.source[1] === '?'</code> ä¸º trueï¼Œ æ³¨é‡Šçš„å†…å®¹åŒ…å« <code>?</code>ï¼Œå¦åˆ™ä¸åŒ…å«ã€‚ç„¶åå¯»æ‰¾ç»“æŸæ ‡ç­¾<code>&gt;</code>ï¼Œæ‰¾ä¸åˆ°æ¶ˆè´¹å…¨éƒ¨çš„ sourceã€‚å¯¹äº closeIndex + 1, å› ä¸ºè¿™æ‰æ˜¯æ•´ä¸ªæ³¨é‡Šçš„é•¿åº¦ã€‚</p> <p>æ¥ä¸‹æ¥è®²è§£ parseCDATAã€‚ä¸€å¼€å§‹ä¹Ÿæ˜¯ä¸¤ä¸ªæ–­è¨€ï¼Œç¥–å…ˆä¸èƒ½ä¸ºç©ºï¼Œç¥–å…ˆçš„å‘½åç©ºé—´ä¸èƒ½æ˜¯ Namespaces.HTMLï¼Œç„¶åä¹Ÿæ˜¯è¦æ±‚ <code>&lt;![CDATA[</code> å¼€å¤´çš„ã€‚æ¥ç€å¾€å‰æ¨è¿› contextï¼Œåœ¨é‡Œé¢åµŒå¥—è°ƒç”¨ parseChildrenï¼Œ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ˜¯çš„ <code>ancestors</code> æ²¡æœ‰å…ƒç´ è¿›æ ˆï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ”¹å˜å‘½åç©ºé—´ï¼Œç¬¬äºŒæ˜¯è§£ææ¨¡å¼æ˜¯ <code>TextModes.CDATA</code>ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªåµŒå¥— parseChildren é‡Œé¢åªæ˜¯è°ƒç”¨ parseText å»è§£æèŠ‚ç‚¹ã€‚åŒæ—¶è¿”å›æ¥çš„å†…å®¹å¯èƒ½åŒ…å«å¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯ parseChildren çš„å¾ªç¯é‡Œé¢éœ€è¦åˆ¤æ–­è¿”å›çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯æ•°ç»„çš„åŸå› äº†ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseCDATA</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span>ns <span class="token operator">!==</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">)</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'&lt;![CDATA['</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span><span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_CDATA</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">']]&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> nodes
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>å›åˆ°å¾ªç¯, å½“ <code>s[1]</code> æ˜¯ <code>/</code> æ—¶ï¼Œ å¦‚æœé•¿åº¦å°±ä¸º2ï¼Œä¸ŠæŠ¥ <code>EOF_BEFORE_TAG_NAME</code> é”™è¯¯ï¼Œçœ‹è‹±æ–‡éƒ½å¤§æ¦‚çŸ¥é“å•¥æ„æ€äº†ï¼Œæ²¡æ‰¾åˆ° tag å°±ç»“æŸäº†ã€‚å¦‚æœ <code>s[2] === '&gt;'</code>ï¼Œ ä¸ŠæŠ¥ <code>MISSING_END_TAG_NAME</code> é”™è¯¯ï¼Œ å¾€å‰æ¨è¿›3é•¿åº¦ï¼Œå¦‚æœ emitError ä¸æŠ›å‡ºé”™è¯¯çš„è¯ï¼Œç›¸å½“äºè§£æå™¨å®¹å¿è¿™ä¸ªé”™è¯¯ï¼Œ continue ç»§ç»­è§£æã€‚å¦‚æœ <code>/[a-z]/i.test(s[2])</code> æˆç«‹ï¼Œå°±æ˜¯ç±»ä¼¼ <code>&lt;/div&gt;</code>ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ html æ ‡ç­¾è¦ä¹ˆæ˜¯æˆå¯¹å‡ºç°æˆ–è€… Void Tag,è€Œè¿™ç§æƒ…å†µä¼šåœ¨ä¸‹é¢ parseElement è¢«å¤„ç†ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ŠæŠ¥ <code>X_INVALID_END_TAG</code> é”™è¯¯ï¼Œ å¹¶ä¸”è°ƒç”¨ parseTag è§£æèŠ‚ç‚¹ã€‚æœ€åï¼Œå¦‚æœå‰é¢çš„åˆ¤æ–­éƒ½ä¸æ»¡è¶³ï¼Œå°±æ‰å…¥å‰é¢æ‰€è¯´çš„ parseBogusComment ä¸­æ­£åˆ™åŒ¹é…çš„æœ€åä¸€é¡¹ï¼ŒåŒæ—¶ä¸ŠæŠ¥ <code>INVALID_FIRST_CHARACTER_OF_TAG_NAME</code> é”™è¯¯ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// https://html.spec.whatwg.org/multipage/parsing.html#end-tag-open-state</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_BEFORE_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&gt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">MISSING_END_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_INVALID_END_TAG</span><span class="token punctuation">)</span>
    <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>
      context<span class="token punctuation">,</span>
      ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">,</span>
      <span class="token number">2</span>
    <span class="token punctuation">)</span>
    node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>å›åˆ°å¾ªç¯ï¼Œ<code>else if (s[1] === '/') {</code> åˆ†æ”¯è®²è§£å®Œæ¯•ï¼Œæ¥ä¸‹æ¥è®² <code>/[a-z]/i.test(s[1])</code> åˆ†æ”¯ã€‚è¿™ä¸ªåˆ†æ”¯ï¼Œå°±æ˜¯æ•´å„¿å…«ç»åœ°å¤„ç†æ ‡ç­¾çš„åˆ†æ”¯äº†ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node <span class="token operator">=</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ä¸‹é¢å°±æ˜¯ parseElement å‡½æ•°ã€‚è¿˜æ˜¯å¼€å±€æ–­è¨€æ˜¯ä¸æ˜¯ç¬¦åˆ Element çš„å¼€å¤´ï¼ŒwasInPre ã€wasInVPre éƒ½æ˜¯ä¸ºäº†ä¿å­˜å½“å‰çš„ pre çŠ¶æ€ï¼Œå› ä¸ºä¸‹é¢è§£æ parseTag çš„æ—¶å€™ context ä¸Šçš„å€¼ä¼šæ”¹å˜ï¼Œè€Œå¦‚æœè§£æå inPre æˆ–è€… inVPre å˜ä¸º trueï¼Œè€Œä»¥å‰æ˜¯ falseï¼Œå°±è¯´æ˜å½“å‰æ ‡ç­¾æ˜¯ pre æˆ–è€… v-pre çš„è¾¹ç•Œç‚¹ï¼Œä¹Ÿå°±æ˜¯ç”±å®ƒå¼€å¯çš„ï¼Œåœ¨ parseElement çš„æœ€åä¹Ÿè¦æ¢å¤æˆåŸæ¥çš„çŠ¶æ€ã€‚æˆ‘ä»¬çœ‹åˆ° parseElement ç”¨åˆ°äº† parseTag å»è§£ææ ‡ç­¾ï¼Œé‚£ä¹ˆè·Ÿç€æ­¥ä¼ï¼Œå»çœ‹çœ‹ parseTagã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token regex">/^&lt;[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// Start tag.</span>
  <span class="token keyword">const</span> wasInPre <span class="token operator">=</span> context<span class="token punctuation">.</span>inPre
  <span class="token keyword">const</span> wasInVPre <span class="token operator">=</span> context<span class="token punctuation">.</span>inVPre
  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>Start<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token keyword">const</span> isPreBoundary <span class="token operator">=</span> context<span class="token punctuation">.</span>inPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wasInPre
  <span class="token keyword">const</span> isVPreBoundary <span class="token operator">=</span> context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wasInVPre

  <span class="token operator">...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPreBoundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inPre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isVPreBoundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inVPre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> element
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>parseTag ä¸ä»…ä»…ç”¨äºåœ¨ parseElement ä¸­è§£ææ ‡ç­¾ï¼ŒåŒæ—¶æˆ‘ä»¬åœ¨ä¸Šé¢è®²è¿‡ä¸€äº›æƒ…å†µè¿›è¡Œå…œåº•ï¼Œå°±æ˜¯åªæœ‰ç»“æŸæ ‡ç­¾çš„æƒ…å†µã€‚</p> <p>å¯ä»¥çœ‹åˆ°ä¸€ä¸Šæ¥ä¹Ÿæ˜¯å…ˆå¯¹æˆ‘ä»¬çš„å­—ç¬¦ä¸²è¿›è¡Œæ–­è¨€ï¼ŒåŒæ—¶åˆ¤æ–­æˆ‘ä»¬çš„å­—ç¬¦ä¸²æ˜¯å¦è·Ÿæˆ‘ä»¬è¦è§£æçš„ TagType æ¨¡å¼æ˜¯å¦åŒ¹é…ï¼Œæ€»ä¸èƒ½ä½ ä¼ è¿›æ¥å¼€å§‹çš„tagï¼Œå‘Šè¯‰æˆ‘è¿™æ˜¯ç»“æŸæ¨¡å¼ã€‚</p> <p>æ¥ç€æ‹¿åˆ°å¼€å§‹ä½ç½® startã€æ­£åˆ™å»åŒ¹é…æ ‡ç­¾ã€æ‹¿åˆ° tagã€æ‹¿åˆ°å½“å‰æ ‡ç­¾æ‰€å¤„çš„å‘½åç©ºé—´ï¼ˆè¿™ä¸ªæ˜¯ options ä¼ è¿›æ¥çš„ï¼‰ï¼Œéœ€è¦æ³¨æ„æ­£åˆ™ä¸­ tag å¼€å¤´åªèƒ½æ˜¯ <code>[a-z]</code>, å¹²å®Œè¿™äº›ï¼Œæˆ‘ä»¬å¼€å§‹å¾€å‰æ¨è¿› contextï¼Œæ¶ˆè€—æ ‡ç­¾ã€æ¶ˆè€—ç©ºæ ¼ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†æˆ‘ä»¬ä¸‹é¢è¿›è¡Œæ ‡ç­¾å±æ€§çš„è§£æï¼Œç„¶åä¿å­˜å½“å‰çš„ä½ç½®å’Œå­—ç¬¦ä¸²ï¼Œå› ä¸ºå¦‚æœåé¢è§£æå±æ€§è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°äº† v-pre æ ‡ç­¾ï¼Œéœ€è¦é‡æ–°è§£ææ ‡ç­¾å±æ€§ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Œåé¢ä¼šè®²åˆ°ã€‚</p> <p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ parseTag é‡Œé¢ï¼Œåˆè°ƒç”¨äº† parseAttributes å»è§£ææ ‡ç­¾çš„å±æ€§ï¼Œprops æ˜¯æˆ‘ä»¬è§£æå›æ¥çš„å±æ€§æ•°ç»„ã€‚æ¥ç€æˆ‘ä»¬åˆæ ¡éªŒæ˜¯ä¸æ˜¯ isPreTagï¼Œè¿™ä¸ªæ ¡éªŒæ–¹æ³•æ˜¯ä» options é€ä¼ ä¸‹æ¥çš„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ° context åœ¨è§£æè¿‡ç¨‹ä¸­ä¸€ç›´å¤„äºå˜åŒ–è¿‡ç¨‹çš„ã€‚æ¥ä¸‹æ¥å…³é”®çš„ä¸€æ­¥æ¥äº†ï¼Œå¦‚æœä»¥å‰ä¸æ˜¯ isInPre ä½†æ˜¯è§£æå‡ºæ¥çš„ props æœ‰ v-pre æŒ‡ä»¤ï¼Œå¦‚æœæœ‰,context.isInPre å°±ä¸º true çŠ¶æ€ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ¢å¤è§£æ props ä¹‹å‰çš„ source å’Œ ä½ç½®ï¼Œæˆ‘ä»¬è¦é‡æ–°è§£æ propsï¼Œå¯ä»¥é€éœ²çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªå½±å“åˆ°æˆ‘ä»¬éœ€ä¸éœ€è¦å¯¹å†…ç½®çš„ä¸€äº›æŒ‡ä»¤è¿›è¡ŒäºŒæ¬¡è½¬åŒ–ï¼Œå¦‚æœæ˜¯å¤„äº v-pre ç¯å¢ƒä¸‹æ¥ï¼Œé‚£ä¹ˆåˆ™ä¸éœ€è¦è½¬åŒ–ï¼Œè¿™ä¸ªåé¢ç»†è®²ã€‚</p> <p>æˆ‘ä»¬è¦çœ‹çœ‹è¿™ä¸ªæ ‡ç­¾æ˜¯å¦æ­£ç¡®å…³é—­ï¼Œsource æ²¡äº†ï¼Œè‚¯å®šä¸è¡Œï¼Œä¸ŠæŠ¥ <code>EOF_IN_TAG</code>, å¦‚æœæˆ‘ä»¬è§£æçš„æ˜¯ç»“æŸæ ‡ç­¾ï¼Œåˆç¢°åˆ°äº†è‡ªé—­åˆçš„å­—ç¬¦ <code>/&gt;</code>ï¼Œä¹Ÿä¸è¡Œå•Šï¼Œä¸ŠæŠ¥ <code>END_TAG_WITH_TRAILING_SOLIDUS</code>, åŒæ—¶å¾€å‰æ¨è¿› contextã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * Parse a tag (E.g. `&lt;div id=a&gt;`) with that type (start tag or end tag).
 */</span>
<span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  type<span class="token operator">:</span> TagType<span class="token punctuation">,</span>
  parent<span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ElementNode <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token regex">/^&lt;\/?[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>
  __TEST__ <span class="token operator">&amp;&amp;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>
      type <span class="token operator">===</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'&lt;/'</span><span class="token punctuation">)</span> <span class="token operator">?</span> TagType<span class="token punctuation">.</span>End <span class="token operator">:</span> TagType<span class="token punctuation">.</span>Start<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

  <span class="token comment">// Tag open.</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token operator">!</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> ns <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

  <span class="token comment">// save current state in case we need to re-parse attributes with v-pre</span>
  <span class="token keyword">const</span> cursor <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> currentSource <span class="token operator">=</span> context<span class="token punctuation">.</span>source

  <span class="token comment">// Attributes.</span>
  <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> type<span class="token punctuation">)</span>

  <span class="token comment">// check &lt;pre&gt; tag</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">isPreTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inPre <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// check v-pre</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span>
    props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'pre'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inVPre <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// reset context</span>
    <span class="token function">extend</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>source <span class="token operator">=</span> currentSource
    <span class="token comment">// re-parse attrs and filter out v-pre itself</span>
    props <span class="token operator">=</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'v-pre'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Tag close.</span>
  <span class="token keyword">let</span> isSelfClosing <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_TAG</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    isSelfClosing <span class="token operator">=</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'/&gt;'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End <span class="token operator">&amp;&amp;</span> isSelfClosing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    tagType<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    isSelfClosing<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token comment">// to be created during transform phase</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p>parseTag è§£æå®Œå±æ€§ã€æ ‡ç­¾ï¼Œæ¥ä¸‹æ¥å°±è¦åˆ¤æ–­è¿™ä¸ª Tag æ ‡ç­¾çš„ tagType äº†ï¼Œæ³¨æ„æˆ‘ä»¬è·Ÿ AST çš„ type åŒºåˆ«å¼€æ¥ï¼Œtype åªæ˜¯åŒºåˆ«è¿™ä¸ª AST å¤§è‡´æ˜¯ä»€ä¹ˆç±»å‹ï¼Œ tagType æ˜¯ç»†åˆ†åˆ°æˆ‘ä»¬è¿™ä¸ªå±äº ElementTypes çš„ä»€ä¹ˆç±»å‹ï¼Œè¿™å¯¹äºåç»­ diff å’Œ transform ç­‰å¾ˆå¤šåœ°æ–¹èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ã€‚</p> <p>åº·åº·ä¸‹é¢ï¼Œé»˜è®¤çš„ tagType æ˜¯ ElementTypes.ELEMENTï¼Œç„¶åå¼€å¯æˆ‘ä»¬çš„åˆ¤æ–­ï¼Œä¹Ÿæ˜¯ v-pre åˆ™è·³è¿‡åˆ¤æ–­ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªç‚¹å°±æ˜¯ isCustomElement è‡ªå®šä¹‰æ ‡ç­¾ï¼Œè¿™ä¸ªå¸¸è§çš„ç”¨æ³•å°±æ˜¯æˆ‘ä»¬çš„è‡ªå®šä¹‰çš„ WebComponentã€‚</p> <p>å¦‚æœè¿›å…¥äº†ç¬¬ä¸€å±‚åˆ¤æ–­ï¼Œæˆ‘ä»¬é¦–å…ˆå»æœå¯»æœ‰æ²¡æœ‰ is æŒ‡ä»¤ï¼Œå¯¹äºä¸æ˜¯å¹³å°åŸç”Ÿ tag ä¸”æ²¡æœ‰ is æŒ‡ä»¤çš„ï¼Œæˆ‘ä»¬è®¤ä¸º tagType æ˜¯ ElementTypes.COMPONENTã€‚å¯¹äº dom å¹³å°ï¼Œ
åŸç”Ÿ tag å°±æ˜¯ <code>isNativeTag: tag =&gt; isHTMLTag(tag) || isSVGTag(tag)</code>ã€‚</p> <p>è€Œå¦‚æœæœ‰ is æŒ‡ä»¤ ã€æ¡†æ¶æ ¸å¿ƒç»„ä»¶ã€å¹³å°å†…å»ºç»„ä»¶ã€å¤§å†™å¼€å¤´çš„æ ‡ç­¾ã€tag æ˜¯ component çš„ï¼Œæˆ‘ä»¬éƒ½è®¤ä¸ºæ˜¯ ElementTypes.COMPONENTã€‚å¤§å†™å¼€å¤´çš„æ ‡ç­¾ï¼Œè¿™ä¸ªæˆ‘ä»¬å†™è¿‡ vue éƒ½çŸ¥é“äº†ï¼Œtag æ˜¯ component æ›´ä¸è¦è¯´äº†ã€‚æ¡†æ¶æ ¸å¿ƒç»„ä»¶å°±æ˜¯åŒ…æ‹¬äº† Teleportã€Suspenseã€KeepAliveã€BaseTransitionï¼Œä½ å¯ä»¥è®¤ä¸ºæ˜¯ä¸å¹³å°æ— å…³çš„å†…ç½®ç»„ä»¶ï¼Œè€Œå¹³å°å†…å»ºç»„ä»¶å°±æ˜¯ Transitionã€ TransitionGroupã€‚</p> <p>å¯¹äº tag ä¸º slotï¼Œæˆ‘ä»¬æ ‡è¯†ä¸º ElementTypes.SLOTï¼Œ å—¯è¦ç‰¹æ®Šå¤„ç†ã€‚</p> <p>è€Œå¯¹äº tag ä¸º templateçš„ï¼Œåªæœ‰å®ƒæœ‰ <code>if,else,else-if,for,slot</code> è¿™äº›æŒ‡ä»¤ï¼Œæˆ‘ä»¬åœ¨è®¤ä¸ºä»–æ˜¯ ElementTypes.TEMPLATEã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> context<span class="token punctuation">.</span>options
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span><span class="token function">isCustomElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hasVIs <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
      <span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'is'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>isNativeTag <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasVIs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span><span class="token function">isNativeTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">COMPONENT</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      hasVIs <span class="token operator">||</span>
      <span class="token function">isCoreComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>options<span class="token punctuation">.</span>isBuiltInComponent <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span><span class="token function">isBuiltInComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token regex">/^[A-Z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">||</span>
      tag <span class="token operator">===</span> <span class="token string">'component'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">COMPONENT</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">SLOT</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span>
      props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          p<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSpecialTemplateDirective</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isCoreComponent</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> symbol <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInType</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token string">'Teleport'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">TELEPORT</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInType</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token string">'Suspense'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">SUSPENSE</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInType</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token string">'KeepAlive'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">KEEP_ALIVE</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInType</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token string">'BaseTransition'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">BASE_TRANSITION</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

isBuiltInComponent<span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> symbol <span class="token operator">|</span> <span class="token parameter"><span class="token keyword">undefined</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInType</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Transition</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">TRANSITION</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInType</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TransitionGroup</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">TRANSITION_GROUP</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token keyword">const</span> isSpecialTemplateDirective <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">if,else,else-if,for,slot</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>å›åˆ° parseTag æ”¶å°¾ï¼Œæœ€åè¿”å› AST ç±»å‹ä¸º NodeTypes.ELEMENTï¼ŒcodegenNode åœ¨ transform é˜¶æ®µçš„ transformElement æ—¶ä¼šç”Ÿæˆï¼Œ children æ˜¯ä»–ä¸‹ä¸€çº§çš„ node çš„æŒ‚è½½ç‚¹ã€‚å¯¹äº parseTag ï¼Œæœ‰ä¸¤ä¸ªç‚¹è¿˜éœ€è¦è¡¥å……ï¼Œä¸€ä¸ªæ˜¯ getNamespace ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ parseAttributesã€‚å†æ¬¡æé†’çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜åœ¨ parseElement é‡Œé¢è¿˜æ²¡æ¸¸å‡ºæ¥å‘¢ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    tagType<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    isSelfClosing<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token comment">// to be created during transform phase</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>getNamespace ä¸»è¦æ˜¯å¯¹ä¸ºäº†è·å–æ­£ç¡®çš„å‘½åç©ºé—´ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢ä¸€ç›´è¯´çš„ï¼Œä¸åŒçš„å‘½åç©ºé—´ä¼šå¯¹è§£ææ˜¯æœ‰å½±å“çš„ï¼Œå¯¹äº dom å¹³å°æ¥è¯´ï¼Œç›®å‰å°±ä¸‰ç§å‘½åç©ºé—´ï¼Œ<code>DOMNamespaces.HTML</code> html å‘½åç©ºé—´ï¼Œ<code>DOMNamespaces.MATH_ML</code> math ml å‘½åç©ºé—´ï¼Œ<code>DOMNamespaces.SVG</code> svg å‘½åç©ºé—´ã€‚</p> <p>åœ¨ getNamespace å†…éƒ¨ï¼Œé¦–å…ˆæ‹¿åˆ°çˆ¶çº§çš„å‘½åç©ºé—´ï¼Œé»˜è®¤æ˜¯ DOMNamespaces.HTMLã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰æˆ‘ä»¬æ²¡æœ‰å¯¹ ns å˜é‡è¿›è¡Œè¦†ç›–æˆ–è€…æå‰ returnï¼Œåˆ™è¯´æ˜å½“å‰ tag çš„ ns è·Ÿ çˆ¶çº§çš„ ns ä¸€æ ·ï¼Œå› ä¸ºå‡½æ•°æœ€åçš„æŠŠ ns è¿”å›å»çš„ã€‚</p> <p>æ¥ä¸‹æ¥å°†é’ˆå¯¹çˆ¶çº§å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œè§£æï¼Œå¦‚æœçˆ¶çº§ ns æ˜¯ MATH_ML ä¸” çˆ¶çº§æ ‡ç­¾æ˜¯ <code>annotation-xml</code> ï¼Œè¿™æ—¶å½“å‰æ ‡ç­¾æ˜¯ <code>svg</code>ï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯å¤„äº svg çš„ nsï¼Œè€Œè¿™æ—¶æ ‡ç­¾ä¸æ˜¯ svg ä½†æ˜¯çˆ¶çº§ annotation-xml æ ‡ç­¾çš„ å±æ€§é‡Œé¢æœ‰ç”³æ˜ä¸‹é¢æ˜¯ html å³ <code>text/html</code> æˆ– <code>application/xhtml+xml</code>ï¼Œ æˆ‘ä»¬ä¹Ÿè®¤ä¸ºæ˜¯ HTML çš„ nsã€‚å¯¹äºçˆ¶çº§æ ‡ç­¾ ä¸æ˜¯<code>annotation-xml</code> ï¼Œä¸”<code>/^m(?:[ions]|text)$/.test(parent.tag) &amp;&amp; tag !== 'mglyph' &amp;&amp; tag !== 'malignmark'</code>,æˆ‘ä»¬è¿˜æ˜¯è®¤ä¸ºåœ¨ HTML çš„ nsã€‚å¦‚æœä¸Šé¢æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œ MATH_ML è¿™ä¸ª ns è®²ä¼ é€’ç»™å½“å‰ tagã€‚</p> <p>è€Œå¯¹äºçˆ¶çº§æ˜¯ SVG çš„ nsï¼Œåªæœ‰çˆ¶çº§ tag æ˜¯ <code>parent.tag === 'foreignObject' || parent.tag === 'desc' || parent.tag === 'title'</code> è¿™äº› tag çš„æ—¶å€™ï¼Œå½“å‰ tag æ‰ç®—åœ¨ HTML çš„nsï¼Œå¦åˆ™ç»§ç»­ SVG çš„ nsã€‚</p> <p>æœ€åå¯¹äºçˆ¶çº§ ns ä¸º HTML çš„å¤„ç†ï¼Œä¸»è¦å½“å‰ tag æ˜¯ <code>svg</code> æˆ–è€… <code>math</code>, åˆ™ä¼šå˜åŒ– ns ä¸º SVG æˆ–è€… MATH_MLã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// https://html.spec.whatwg.org/multipage/parsing.html#tree-construction-dispatcher</span>
<span class="token function">getNamespace</span><span class="token punctuation">(</span>tag<span class="token operator">:</span> string<span class="token punctuation">,</span> parent<span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token operator">:</span> DOMNamespaces <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ns <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>ns <span class="token operator">:</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">HTML</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> ns <span class="token operator">===</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">MATH_ML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'annotation-xml'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'svg'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">SVG</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          parent<span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
            <span class="token parameter">a</span> <span class="token operator">=&gt;</span>
              a<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span> <span class="token operator">&amp;&amp;</span>
              a<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'encoding'</span> <span class="token operator">&amp;&amp;</span>
              a<span class="token punctuation">.</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
              <span class="token punctuation">(</span>a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>content <span class="token operator">===</span> <span class="token string">'text/html'</span> <span class="token operator">||</span>
                a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>content <span class="token operator">===</span> <span class="token string">'application/xhtml+xml'</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ns <span class="token operator">=</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">HTML</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token regex">/^m(?:[ions]|text)$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        tag <span class="token operator">!==</span> <span class="token string">'mglyph'</span> <span class="token operator">&amp;&amp;</span>
        tag <span class="token operator">!==</span> <span class="token string">'malignmark'</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ns <span class="token operator">=</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">HTML</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> ns <span class="token operator">===</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">SVG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        parent<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'foreignObject'</span> <span class="token operator">||</span>
        parent<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'desc'</span> <span class="token operator">||</span>
        parent<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'title'</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ns <span class="token operator">=</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">HTML</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">===</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'svg'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">SVG</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'math'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DOMNamespaces<span class="token punctuation">.</span><span class="token constant">MATH_ML</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ns
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>OKï¼Œé‚£ç°åœ¨å°±è®²è®² parseAttributes ï¼Œçœ‹çœ‹æ˜¯æ€ä¹ˆè§£æå±æ€§çš„ï¼Œä¹Ÿåœ¨è¿™é‡Œæ­ç§˜ä¸ºä»€ä¹ˆ v-pre è¦é‡æ–°è§£æä¸€æ¬¡å±æ€§ã€‚ props æ˜¯æœ€åè¿”å›å»çš„å±æ€§æ•°ç»„ï¼ŒåŒæ—¶ç»´æŠ¤ä¸€ä¸ª attributeNames ç”¨äºè§£æå±æ€§è¿‡ç¨‹ä¸­è¿›è¡Œå»é‡æ ¡éªŒã€‚æ¥ä¸‹æ¥ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª while ä¸æ–­å»è¯»å–å­—ç¬¦ä¸²ï¼Œå¦‚æœ source æ¶ˆè€—å®Œæ¯• åˆæˆ–è€…é‡åˆ°äº†æ ‡ç­¾ç»“æŸçš„ç¬¦å· <code>&gt;</code> æˆ– <code>/&gt;</code>, æ‰é€€å‡ºå¾ªç¯ã€‚ è¿›å»å¾ªç¯åï¼Œå¦‚æœä¸€å¼€æ³¢å°±ç»™æˆ‘ä»¬ä¸€ä¸ª <code>/</code>ï¼Œä¸ŠæŠ¥ <code>UNEXPECTED_SOLIDUS_IN_TAG</code> é”™è¯¯ï¼Œå¾€å‰æ¨è¿› context åŒæ—¶æ¶ˆè€—ç©ºæ ¼ã€‚å¦‚æœè¦å¼€å§‹è§£æå…·ä½“å±æ€§äº†ï¼Œä½†æ˜¯ type æ˜¯ <code>TagType.End</code>ï¼Œè¿™ä¹Ÿä¸è¡Œï¼Œä¸èƒ½åœ¨ç»“æŸæ ‡ç­¾å¸¦å±æ€§ï¼Œä¸ŠæŠ¥ <code>END_TAG_WITH_ATTRIBUTES</code>  é”™è¯¯ã€‚æ¥ç€ä½¿ç”¨ parseAttribute å»è§£æå…·ä½“æŸä¸ªå±æ€§ï¼Œè§£ææˆåŠŸåï¼Œå†æ¬¡æ ¡éªŒæ˜¯å¦æ˜¯ TagType.Startï¼Œ å¦‚æœæ˜¯ï¼Œå¡å…¥ props æ•°ç»„ï¼ŒåŒæ—¶å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸‹ä¸ªå±æ€§ä¸å½“å‰å±æ€§æ²¡æœ‰ <code>[^\t\r\n\f /&gt;]</code> è¿™äº›åšé—´éš”ï¼Œä¸ŠæŠ¥ <code>MISSING_WHITESPACE_BETWEEN_ATTRIBUTES</code> é”™è¯¯ï¼Œå°±æ˜¯ç±»ä¼¼ <code>&lt;div id=&quot;foo&quot;class=&quot;bar&quot;&gt;&lt;/div&gt;</code>, id å’Œ  class ä¹‹é—´æ²¡æœ‰é—´éš”ï¼Œå¾ªç¯æœ€åæ¶ˆè€—å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼ã€‚å°±è¿™æ ·çš„ä¸€ä¸ªå¾ªç¯ï¼ŒæŠŠ Tag ä¸Šçš„å…¨éƒ¨æ ‡ç­¾è§£æå‡ºæ¥ï¼Œæœ€å return å‡ºå»ã€‚å½“ç„¶å…·ä½“å•ä¸ªå±æ€§çš„è§£æåœ¨ parseAttribute å‡½æ•°é‡Œé¢ï¼Œä¸‹é¢å°±è®²åˆ°ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  type<span class="token operator">:</span> TagType</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span>AttributeNode <span class="token operator">|</span> DirectiveNode<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> attributeNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'/&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_SOLIDUS_IN_TAG</span><span class="token punctuation">)</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_ATTRIBUTES</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> attr <span class="token operator">=</span> <span class="token function">parseAttribute</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attributeNames<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>Start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      props<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^[^\t\r\n\f /&gt;]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">MISSING_WHITESPACE_BETWEEN_ATTRIBUTES</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> props
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>å¯¹äºå…·ä½“å±æ€§è§£æï¼Œåˆ†æˆä¸¤éƒ¨åˆ†ï¼ŒparseAttribute å’Œ parseAttributeValueï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å±æ€§å¤§éƒ¨åˆ†æœ‰å€¼ã€‚</p> <p>é—²è¯ä¸å¤šè¯´ï¼Œçœ‹çœ‹ parseAttributeã€‚æ–­è¨€ source å·²ç»æ€è€ƒè§æƒ¯äº†ï¼Œæ¥ç€ä¿å­˜ name çš„ä½ç½®ï¼ŒåŒæ—¶å°è¯•ç”¨æ­£åˆ™å»åŒ¹é…å­—ç¬¦ä¸²è·å–å±æ€§çš„åå­— nameï¼Œè¿™ä¸ªæ­£åˆ™ä¹Ÿæ˜¯å¾ˆå®½æ³›ï¼Œå°±æ˜¯æ’é™¤ç©ºç™½å­—ç¬¦å’Œç»“æŸå­—ç¬¦ï¼ŒåŒæ—¶å¯¹äºå±æ€§åå­—çš„ç¬¬ä¸€ä½å…è®¸ <code>=</code>ï¼Œè™½ç„¶åœ¨ä¸‹é¢ä¼šä¸ŠæŠ¥ <code>UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME</code> é”™è¯¯ï¼Œå±æ€§åå­—çš„åé¢å°±ä¸å…è®¸ <code>=</code> ç¬¦å·äº†ï¼Œæ¯•ç«Ÿè¿™æ˜¯ç”¨æ¥åˆ‡å‰²å±æ€§åå’Œå±æ€§å€¼çš„ã€‚</p> <p>nameSet å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢ parseAttributes ä¼ ä¸‹æ¥çš„ set é›†åˆï¼Œå¦‚æœé‡å¤äº†ï¼Œä¸ŠæŠ¥ DUPLICATE_ATTRIBUTEã€‚è®°ç€æŠŠæˆ‘ä»¬çš„å±æ€§ååŠ å…¥ set é›†åˆé‡Œé¢ã€‚</p> <p>é™¤äº†ç­‰å·ä¸èƒ½å‡ºç°åœ¨é›†åˆåï¼Œ <code>/[&quot;'&lt;]/g</code> è¿™äº›ä¹Ÿä¸å¯ä»¥ï¼Œå¯¹äºæ£€æµ‹åˆ°çš„ï¼Œä¸ŠæŠ¥ <code>UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME</code> é”™è¯¯ã€‚</p> <p>ç»§ç»­å¾€å‰æ¨è¿›ï¼Œæ¥ç€å¼€å§‹è§£æå±æ€§å€¼ï¼Œå¯¹äºä¸€ä¸ªå±æ€§è€Œè¨€ï¼Œä¸ä¸€å®šæœ‰å±æ€§å€¼ï¼Œæ‰€ä»¥éœ€è¦æ­£åˆ™åŒ¹é…åˆ¤æ–­ä¸€ä¸‹ï¼Œæ²¡é—®é¢˜ä¹‹åï¼Œéœ€è¦ç­‰å·å‰é¢å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼ã€ç­‰å·é•¿åº¦ã€ç­‰å·åé¢çš„ç©ºæ ¼ï¼Œåšå®Œè¿™äº›é¢„å¤‡åŠ¨ä½œï¼Œæ‰å¼€å§‹çœŸæ­£è°ƒç”¨ parseAttributeValue å»è§£æå±æ€§å€¼ï¼Œå½“ç„¶å¦‚æœè§£æä¸åˆ°å±æ€§å€¼ï¼Œä¸ŠæŠ¥ <code>MISSING_ATTRIBUTE_VALUE</code> é”™è¯¯ã€‚</p> <p>åœ¨ è¿”å› Attribute ä¹‹å‰ï¼Œä¼šå¯¹ directive æŒ‡ä»¤å±æ€§è¿›è¡Œè§£æï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸‹é¢ parseAttribute çœç•¥å·çš„åœ°æ–¹ï¼Œå‡è®¾æˆ‘ä»¬çš„å±æ€§ä¸æ˜¯æŒ‡ä»¤ï¼Œ æœ€åè¿”å›çš„ AST ç»“æ„å°±æ˜¯ç±»å‹ä¸º <code>NodeTypes.ATTRIBUTE</code>, åå­—æ˜¯å±æ€§åå­—ï¼Œ value æ˜¯ å±æ€§å€¼ AST è¡¨ç¤ºï¼Œä¹Ÿå¯èƒ½ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œç±»å‹æ˜¯ <code>NodeTypes.TEXT</code>ï¼Œvalue é‡Œé¢çš„ value ç”¨  parseAttribute é‡Œé¢è¿”å›çš„ ast è¡¨ç¤ºã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseAttribute</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  nameSet<span class="token operator">:</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> AttributeNode <span class="token operator">|</span> DirectiveNode <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token regex">/^[^\t\r\n\f /&gt;]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// Name.</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token operator">!</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nameSet<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">DUPLICATE_ATTRIBUTE</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  nameSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token regex">/[&quot;'&lt;]/g</span>
    <span class="token keyword">let</span> m<span class="token operator">:</span> RegExpExecArray <span class="token operator">|</span> <span class="token keyword">null</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME</span><span class="token punctuation">,</span>
        m<span class="token punctuation">.</span>index
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token comment">// Value</span>
  <span class="token keyword">let</span> value<span class="token operator">:</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        content<span class="token operator">:</span> string
        isQuoted<span class="token operator">:</span> boolean
        loc<span class="token operator">:</span> SourceLocation
      <span class="token punctuation">}</span>
    <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^[\t\r\n\f ]*=/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    value <span class="token operator">=</span> <span class="token function">parseAttributeValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">MISSING_ATTRIBUTE_VALUE</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> loc <span class="token operator">=</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>

  <span class="token operator">...</span> 
 
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    value<span class="token operator">:</span> value <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> value<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      loc<span class="token operator">:</span> value<span class="token punctuation">.</span>loc
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>å¯¹äº parseAttribute ï¼Œä¸Šé¢æˆ‘ä»¬å¿½ç•¥äº†ä¸¤ä¸ªç‚¹ï¼Œç¬¬ä¸€ä¸ª parseAttributeValue ï¼Œç¬¬äºŒæ˜¯æŒ‡ä»¤å±æ€§ã€‚</p> <p>å…ˆçœ‹çœ‹ parseAttributeValueï¼Œé¦–å…ˆä¿å­˜å¼€å§‹ä½ç½®ï¼Œè¿™éƒ½æ˜¯ä¸ºäº†æœ€å AST çš„ locï¼Œç„¶åçœ‹çœ‹æˆ‘ä»¬çš„å±æ€§å€¼æ˜¯ä¸æ˜¯è¢« <code>&quot;</code> æˆ–è€… <code>'</code> åŒ…èµ·æ¥äº†ï¼Œå¦‚æœåŒ…èµ·æ¥äº†ï¼Œè§£æå‰å…ˆå¾€å‰æ¨è¿›ä¸€ä½ï¼ŒåŒæ—¶å¯»æ‰¾ç»“æŸç¬¦ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œç›´æ¥æ¶ˆè´¹å®Œæ•´ä¸ªå­—ç¬¦ä¸²ï¼Œ parseTextData æˆ‘ä»¬åœ¨ä¸Šé¢è®²è¿‡äº†ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œæ¶ˆè´¹ endIndex é•¿åº¦ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒæ—¶æœ€åæ¶ˆè´¹ç»“æŸç¬¦ã€‚</p> <p>å¦‚æœæˆ‘ä»¬çš„å±æ€§å€¼æ²¡æœ‰è¢«å¼•å·åŒ…ä½ï¼Œé¦–å…ˆæ­£åˆ™åŒ¹é…ä¸€ä¸‹ï¼ŒåŸºæœ¬å°±æ˜¯ä¸å…è®¸ç©ºç™½ç¬¦å’Œæ ‡ç­¾'<code>&gt;</code>ï¼Œå¦‚æœåŒ¹é…å¤±è´¥ï¼Œç›´æ¥è¿”å›ï¼Œç„¶åè¿›è¡ŒäºŒæ¬¡æ­£åˆ™æ ¡éªŒï¼Œä¸å…è®¸ <code>/[&quot;'&lt;=</code>]<code>,éœ€è¦æ³¨æ„ ä¹Ÿä¸å¯»</code>&lt;<code>å’Œ</code>=<code>ï¼Œå¦åˆ™ä¸ŠæŠ¥</code>UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE<code>ã€‚è¿™äº›æ ¡éªŒéƒ½æ²¡é—®é¢˜ï¼Œå°±è¿”å› value çš„ AST è¡¨ç¤ºï¼Œæ³¨æ„</code>isQuoted` ä¹Ÿè¦è¿”å›å»ï¼Œåœ¨ parseAttribute ä¸­ä¿®å¤å†…å®¹ locã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseAttributeValue</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token operator">|</span> <span class="token punctuation">{</span>
      content<span class="token operator">:</span> string
      isQuoted<span class="token operator">:</span> boolean
      loc<span class="token operator">:</span> SourceLocation
    <span class="token punctuation">}</span>
  <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">let</span> content<span class="token operator">:</span> string

  <span class="token keyword">const</span> quote <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> isQuoted <span class="token operator">=</span> quote <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">||</span> quote <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isQuoted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Quoted value.</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span><span class="token punctuation">)</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Unquoted</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^[^\t\r\n\f &gt;]+/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> unexpectedChars <span class="token operator">=</span> <span class="token regex">/[&quot;'&lt;=`]/g</span>
    <span class="token keyword">let</span> m<span class="token operator">:</span> RegExpExecArray <span class="token operator">|</span> <span class="token keyword">null</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> unexpectedChars<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE</span><span class="token punctuation">,</span>
        m<span class="token punctuation">.</span>index
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> content<span class="token punctuation">,</span> isQuoted<span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹ parseAttribute ä¸­å¯¹ æŒ‡ä»¤å±æ€§çš„å¤„ç†ã€‚å¦‚æœå‡ºäº inVPre ç¯å¢ƒï¼Œåˆ™æˆ‘ä»¬ä¸éœ€è¦å¯¹æŒ‡ä»¤è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯æœ‰å¯èƒ½æˆ‘ä»¬çˆ¶çº§ä¸æ˜¯ inVPreï¼Œä½†å½“å‰ tag æœ‰ v-pre æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯èƒ½ä¸€å¼€å§‹è¿›å»è¿™é‡Œå¤„ç†äº†ï¼Œåé¢è§£æå®Œæ¯•ä¹‹åï¼Œå‘ç°ä¸éœ€è¦äºŒæ¬¡å¤„ç†ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°é‡æ–°è§£æå±æ€§ã€‚ä½†ä¸ºä»€ä¹ˆä¸åœ¨è¿™é‡Œåšä¸ªæ ¡éªŒå‘¢ï¼Ÿå¥‡æ€ªäº†</p> <p><code>/^(v-|:|@|#)/.test(name)</code> è¿™ä¸ªæ­£åˆ™æ˜¯ä¸ºäº†åˆæ­¥åˆ¤æ–­å±æ€§æ˜¯ä¸æ˜¯æŒ‡ä»¤ï¼Œåœ¨è¿›å» if åˆ¤æ–­ä¹‹åï¼Œä¼šç”¨æ­£åˆ™åšè¿›ä¸€æ­¥çš„åˆ¤æ–­ï¼Œ<code>/(?:^v-([a-z0-9-]+))?(?:(?::|^@|^#)([^\.]+))?(.+)?$/i</code> è¿™ä¸ªçœ‹èµ·æ¥å¾ˆå¤æ‚çš„æ­£åˆ™ï¼Œå°±æ˜¯ä¸ºäº†æå–å±æ€§åä¸­çš„æŒ‡ä»¤åã€æŒ‡ä»¤çš„å‚æ•°ä»¥åŠæ‰§è¡Œçš„ä¿®é¥°ç¬¦ã€‚</p> <p>å¯¹äºåˆ†ç»„2å‰é¢çš„ <code>(?::|^@|^#)</code>ï¼Œå±äºæŒ‡ä»¤çš„è¯­æ³•ç³–ï¼Œåˆ†åˆ«ä»£è¡¨ bindã€ click å’Œslotï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨è¿”å›æŒ‡ä»¤ AST çš„ name é‚£é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³çš„åˆ†ç»„2çš„å†…å®¹è¿›è¡Œæ ¡éªŒï¼Œåˆ†ç»„2å±äºæŒ‡ä»¤çš„å‚æ•°ï¼Œå¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œåƒ <code>v-on:[event]</code>, event å°±æ˜¯åŠ¨æ€å‚æ•°ï¼Œä½†æ˜¯ <code>v-on:[event test]</code> ä¼šä¸ŠæŠ¥ <code>X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END</code> é”™è¯¯çš„ï¼Œå› ä¸ºå‰é¢æˆ‘ä»¬åŒ¹é…å±æ€§åæ­£åˆ™çš„æ—¶å€™ï¼Œä¸åŒ…æ‹¬ç©ºæ ¼ï¼Œæ‰€ä»¥åŠ¨æ€å‚æ•°æ‰¾ä¸åˆ°ç»“æŸç¬¦ <code>]</code>ã€‚å‚æ•°ä¹Ÿä¼šè¿”å›ä¸€ä¸ª ASTï¼Œç±»å‹æ˜¯ SIMPLE_EXPRESSIONï¼Œå…¶ä¸­ isStatic æ˜¯ç”± å‚æ•°æ˜¯ä¸æ˜¯åŠ¨æ€å†³å®šçš„ã€‚</p> <p>æ¥ç€æŒ‡ä»¤è¿˜ä¼šå¯¹å±æ€§å†…å®¹ä½ç½®è¿›è¡Œè£å‰ªï¼Œå¦‚æœæ˜¯ isQuoted ï¼Œä¹Ÿä¼šæŠŠèƒ½å±æ€§å†…å®¹ä½ç½®ä¸­çš„å†…å®¹çš„å¼•å·å»æ‰ï¼ŒåŒæ—¶ä¿®å¤é‡Œé¢çš„å¼€å§‹ã€ç»“æŸä½ç½®ã€‚</p> <p>æœ€åæå‰è¿”å›æŒ‡ä»¤çš„ ASTï¼Œç±»å‹æ˜¯ NodeTypes.DIRECTIVEï¼Œ å…¶ä¸­ name ä¸Šé¢è¯´è¿‡ï¼Œexp æ˜¯è®²å±æ€§å†…å®¹è½¬åŒ–æˆ AST ç±»å‹ä¸º SIMPLE_EXPRESSION çš„èŠ‚ç‚¹ï¼Œå…¶ä¸­è¿™ä¸ªèŠ‚ç‚¹ isConstant ä¼šåœ¨ transformExpression èŠ‚ç‚¹ç¡®å®šçš„ï¼Œç°åœ¨éœ€è¦åšçš„å°±æ˜¯æŠŠè¿™ç‚¹è®°åœ¨æœ¬å­ä¸Šã€‚arg æ˜¯æŒ‡ä»¤å‚æ•°ï¼Œmodifiers æ˜¯æŒ‡ä»¤çš„ä¿®é¥°ç¬¦ï¼Œå±äºæ­£åˆ™ä¸­çš„åˆ†ç»„3é‡Œé¢çš„å†…å®¹ã€</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token regex">/^(v-|:|@|#)/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/(?:^v-([a-z0-9-]+))?(?:(?::|^@|^#)([^\.]+))?(.+)?$/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>
      name
    <span class="token punctuation">)</span><span class="token operator">!</span>
    
    <span class="token keyword">let</span> arg<span class="token operator">:</span> ExpressionNode <span class="token operator">|</span> <span class="token keyword">undefined</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> startOffset <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> loc <span class="token operator">=</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        <span class="token function">getNewPosition</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">,</span> startOffset<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">getNewPosition</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">,</span> startOffset <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">let</span> content <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> isStatic <span class="token operator">=</span> <span class="token boolean">true</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'['</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isStatic <span class="token operator">=</span> <span class="token boolean">false</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">emitError</span><span class="token punctuation">(</span>
            context<span class="token punctuation">,</span>
            ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    
        content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    
      arg <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
        content<span class="token punctuation">,</span>
        isStatic<span class="token punctuation">,</span>
        isConstant<span class="token operator">:</span> isStatic<span class="token punctuation">,</span>
        loc
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>isQuoted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> valueLoc <span class="token operator">=</span> value<span class="token punctuation">.</span>loc
      valueLoc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>offset<span class="token operator">++</span>
      valueLoc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>column<span class="token operator">++</span>
      valueLoc<span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token function">advancePositionWithClone</span><span class="token punctuation">(</span>valueLoc<span class="token punctuation">.</span>start<span class="token punctuation">,</span> value<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
      valueLoc<span class="token punctuation">.</span>source <span class="token operator">=</span> valueLoc<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span>
        match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">':'</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token string">'bind'</span>
          <span class="token operator">:</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'@'</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token string">'on'</span>
            <span class="token operator">:</span> <span class="token string">'slot'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      exp<span class="token operator">:</span> value <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> value<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">// Treat as non-constant by default. This can be potentially set to</span>
        <span class="token comment">// true by `transformExpression` to make it eligible for hoisting.</span>
        isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        loc<span class="token operator">:</span> value<span class="token punctuation">.</span>loc
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      arg<span class="token punctuation">,</span>
      modifiers<span class="token operator">:</span> match<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">?</span> match<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      loc
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>ç»ˆäºæŠŠ parseAttribute è®²å®Œäº†ï¼ŒparseAttribute å›åˆ° parseAttributesï¼ŒparseAttributes å›åˆ° parseTag, parseTag å›åˆ°  parseElementï¼Œè¿™ä¸ªè°ƒç”¨æ ˆæœ‰ç‚¹é•¿ï¼Œå¸Œæœ›ä½ ä»¬è¿˜æ²¡æ™•ã€‚</p> <p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨è¿›å» parseTag è¿™ä¸ªæ—‹æ¶¡ä¹‹å‰ï¼ŒparseElement è®²åˆ°é‚£é‡Œäº†å—ï¼Ÿæˆ‘ä»¬è®²åˆ°äº† <code>const element = parseTag(context, TagType.Start, parent)</code> è¿™é‡Œï¼ŒOKï¼Œè¿™é‡Œæˆ‘ä»¬ç»ˆäºæ‹¿åˆ°äº†æˆ‘ä»¬è§£æçš„å…ƒç´ äº†ã€‚</p> <p>isPreBoundary ä¸º trueï¼Œè¯´æ˜æˆ‘ä»¬è¿™ä¸ªå…ƒç´ å°±æ˜¯ pre ï¼Œå› ä¸º wasInPre ä¸º falseï¼ŒåŒç† isVPreBoundary æ˜¯ v-pre çš„æ ‡è¯†ã€‚</p> <p>å¯¹äºå…ƒç´ è‡ªå·±å…³é—­çš„ï¼Œæˆ–è€…æ˜¯å¹³å°çš„ isVoidTag ï¼Œç›´æ¥è¿”å› elementï¼Œå› ä¸ºä¸éœ€è¦ä¸‹é¢çš„è§£æå­å…ƒç´ å’Œç»“æŸæ ‡ç­¾ã€‚</p> <p>å¯¹äºè§£æå­å…ƒç´ å‰ï¼Œé¦–å…ˆæŠŠå½“å‰å…ƒç´ æ¨å…¥ ancestors ä¸­ï¼Œancestors å½±å“åˆ°äº†æˆ‘ä»¬æ€ä¹ˆå»ç»“æŸ parseChildrenã€namespace çš„åˆ¤æ–­ç­‰ç­‰ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯è§£æä¸­å”¯ä¸€å…¥æ ˆçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå…¶ä»–è§£ææ¥è¯´ï¼Œå¦‚paeCommentã€paserBogusComment ç­‰ç­‰ï¼Œéƒ½æ˜¯æ²¡æœ‰å­å…ƒç´ çš„ï¼Œæˆ‘ä»¬ä» parseTag çš„ AST çœ‹åˆ° children ä¹Ÿå¯ä»¥å¤§æ¦‚çŒœåˆ°äº†ã€‚æ¥ç€æ‹¿ modeï¼ŒgetTextMode æœ€ä¸Šé¢è®²è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰å½“å‰å…ƒç´ å‘½åç©ºé—´æ˜¯ DOMNamespaces.HTML æ—¶ï¼ŒgetTextMode æ‰ä¼šè¿”å›å…¶ä»–çš„TextModesï¼Œå¦åˆ™ä¸€å¾‹éƒ½æ˜¯ TextModes.DATAï¼Œè€Œæˆ‘ä»¬ä¹ŸçŸ¥é“ï¼ŒparseChildren åªå¯¹ <code>mode === TextModes.DATA || mode === TextModes.RCDATA</code> è¿™ä¸¤ä¸ªæ¨¡å¼æœ‰ç»†è‡´çš„è§£æï¼Œä¸ç„¶éƒ½æ˜¯èµ°ç²—æš´çš„ parseTextã€‚ parseChildren è§£æå®Œæ¯•ä¹‹åï¼Œè¿”å›çš„ nodes èŠ‚ç‚¹ï¼Œå¡å…¥  element çš„ childrenï¼ŒåŒæ—¶æŠŠ element ä» ancestors ä¸­å¼¹å‡ºã€‚ç„¶åæˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„ element æœ‰æ²¡æœ‰å…³é—­æ ‡ç­¾ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨ parseTag å»è§£æï¼Œåˆ«å¿˜è®°å‰é¢è¿™ä¸ªå…³é—­æ ‡ç­¾ä¸èƒ½æœ‰å±æ€§ï¼Œè¿™ä¸ªè¿”å›çš„ AST ä¸éœ€è¦ä¿å­˜ï¼Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†æ¨è¿› contextã€‚å¦‚æœæ²¡æœ‰å…³é—­æ ‡ç­¾ï¼Œä¸ŠæŠ¥ <code>X_MISSING_END_TAG</code>, è€Œå¦‚æœç”šè‡³è¿ source ä¹Ÿæ²¡äº†ï¼Œelement çš„ tag æ˜¯ scriptï¼Œä¸”å½“å‰ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ³¨é‡Šï¼Œä¸ŠæŠ¥ <code>EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</code>,å¾ˆæ‡µåœˆæ˜¯ä¸ï¼Œæ¥ï¼Œç»™ä½ çœ‹æµ‹è¯•ç”¨ä¾‹,
<code>&lt;script&gt;&lt;!--console.log('hello')</code>, get ï¼Ÿ</p> <p>parseElement ä¿®å¤ç»“æŸæ ‡ç­¾çš„ä½ç½®ï¼ŒåŒæ—¶é‡ç½® context ä¸­çš„ inPre å’Œ inVPre, å¯ä»¥çœ‹åˆ° parseElement ç›¸æ¯”äº parseTag çš„ASTï¼Œå°±æ˜¯æ·»åŠ äº†å­å…ƒç´ çš„ ASTï¼ŒåŒæ—¶ä¿®å¤ locï¼Œè¿˜æœ‰æ¶ˆè´¹ç»“æŸæ ‡ç­¾ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token regex">/^&lt;[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// Start tag.</span>
  <span class="token keyword">const</span> wasInPre <span class="token operator">=</span> context<span class="token punctuation">.</span>inPre
  <span class="token keyword">const</span> wasInVPre <span class="token operator">=</span> context<span class="token punctuation">.</span>inVPre
  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>Start<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token keyword">const</span> isPreBoundary <span class="token operator">=</span> context<span class="token punctuation">.</span>inPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wasInPre
  <span class="token keyword">const</span> isVPreBoundary <span class="token operator">=</span> context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wasInVPre

  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>isSelfClosing <span class="token operator">||</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">isVoidTag</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> element
  <span class="token punctuation">}</span>

  <span class="token comment">// Children.</span>
  ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  <span class="token keyword">const</span> mode <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTextMode</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
  ancestors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  element<span class="token punctuation">.</span>children <span class="token operator">=</span> children

  <span class="token comment">// End tag.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_END_TAG</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> first <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">&amp;&amp;</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token string">'&lt;!--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  element<span class="token punctuation">.</span>loc <span class="token operator">=</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> element<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPreBoundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inPre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isVPreBoundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inVPre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> element
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>parseElment çš„ä¸Šä¸€çº§è°ƒç”¨æ ˆæ˜¯ parseChildrenï¼Œè¿˜è®°å¾—æˆ‘ä»¬å¤§æ˜æ¹–ç•”çš„ while å¾ªç¯å—ï¼ŸparseElement æˆ‘ä»¬åˆ†æå®Œäº†ï¼Œ<code>s[1] === '?'</code> å°±æ˜¯ <code>&lt;?</code>ï¼Œæˆ‘ä»¬ä¹Ÿè®²è¿‡äº†ã€‚è¿™äº›æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œä¸ŠæŠ¥ <code>INVALID_FIRST_CHARACTER_OF_TAG_NAME</code> é”™è¯¯ï¼Œå°±æ˜¯ <code>&lt;</code> åé¢ä¸çŸ¥é“è·Ÿç€æ˜¯ä»€ä¹ˆå­—ç¬¦ä¸²ã€‚åæ­£æœ€åæœ‰ parseText å…œåº•ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node <span class="token operator">=</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>
    context<span class="token punctuation">,</span>
    ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME</span><span class="token punctuation">,</span>
    <span class="token number">1</span>
  <span class="token punctuation">)</span>
  node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>çœ‹çœ‹ï¼ŒparseText å…œåº•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ pushNode æŠŠè¿”å›çš„èŠ‚ç‚¹å¡å…¥ nodesï¼Œä¸ºä»€ä¹ˆ node ä¼šæ˜¯æ•°ç»„å‘¢ï¼Ÿ parseCDATA é‡Œé¢è°ƒç”¨ parseChildren ï¼Œè€Œ parseCDATA çš„è§£æéƒ½æ˜¯åŒçº§çš„ï¼Œæ‰€ä»¥ä½ æ‡‚çš„ã€‚pushNode çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºäº†åˆå¹¶ç›¸é‚» NodeTypes.TEXT èŠ‚ç‚¹ï¼Œå†æ‹¿  parseCDATA ä¸¾ä¾‹ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­ï¼ŒparseText ä¼šæ ¹æ® endTokens åˆ‡å‰²èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šå‡ºç°å¤šä¸ª NodeTypes.TEXT ä¸åœ¨åŒä¸ª ASTï¼ŒåŒæ ·è¿˜æœ‰æ³¨é‡Šä¸­çš„ä¾‹å­ï¼Œ<code>a &lt; b</code>ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">pushNode</span><span class="token punctuation">(</span><span class="token parameter">nodes<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token operator">:</span> TemplateChildNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ignore comments in production</span>
  <span class="token comment">/* istanbul ignore next */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__DEV__ <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>
    <span class="token comment">// Merge if both this and the previous node are text and those are</span>
    <span class="token comment">// consecutive. This happens for cases like &quot;a &lt; b&quot;.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      prev <span class="token operator">&amp;&amp;</span>
      prev<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span>
      prev<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>end<span class="token punctuation">.</span>offset <span class="token operator">===</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>offset
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prev<span class="token punctuation">.</span>content <span class="token operator">+=</span> node<span class="token punctuation">.</span>content
      prev<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>end <span class="token operator">=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>end
      prev<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source <span class="token operator">+=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>parseChildren æ”¶å°¾éƒ¨åˆ†ï¼Œæ˜¯è¦è¦å¯¹èŠ‚ç‚¹ä¸­çš„ NodeTypes.TEXT ä¸­ç©ºç™½èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚å¯¹äº TextModes.RAWTEXT æ¨¡å¼å°±ä¸è¿›è¡Œå¤„ç†äº†ã€‚</p> <p>å¦‚æœæ˜¯å…¶ä»–æ¨¡å¼ï¼Œcontext.inPre ä¸º falseï¼Œå¾ªç¯æ‰€æœ‰çš„èŠ‚ç‚¹ã€‚å¦‚æœ<code>!/[^\t\r\n\f ]/.test(node.content)</code> ä¸ºçœŸï¼Œ è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹æ˜¯ç©ºç™½èŠ‚ç‚¹ï¼Œå¯¹äºç©ºç™½èŠ‚ç‚¹ï¼Œæ³¨é‡Šä¹Ÿå†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œå¯¹äºç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªç©ºç™½èŠ‚ç‚¹ï¼Œå¯ä»¥å¿½ç•¥ï¼ŒåŒæ—¶å¦‚æœç§»é™¤æ³¨é‡Šå‰åçš„ç©ºç™½èŠ‚ç‚¹ï¼Œè€Œå¯¹äºå¤¹åœ¨ä¸¤ä¸ªå…ƒç´ ä¸­é—´çš„ç©ºç™½èŠ‚ç‚¹ï¼Œå¦‚æœè¿™ä¸ªç©ºç™½èŠ‚ç‚¹æ˜¯å«æœ‰æ¢è¡Œç¬¦ï¼Œæ‰æ‰è¿›è¡Œç§»é™¤ï¼Œå¦‚æœè¦ç§»é™¤èŠ‚ç‚¹ï¼Œå°±å°† <code>removedWhitespace</code> è®¾ä¸º true,è¿™æ ·åœ¨æœ€åè¿”å›çš„æ—¶å€™ï¼Œç”¨ filter(Boolean) è¿‡æ»¤ç½®ç©ºçš„ç©ºç™½èŠ‚ç‚¹ï¼Œ<code>nodes[i] = null as any</code> å°±æ˜¯è¿™æ ·ç½®ç©ºã€‚å¦‚æœç©ºç™½èŠ‚ç‚¹ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒæŠŠç©ºç™½èŠ‚ç‚¹çš„å†…å®¹ç¼©å‡æˆä¸€ä¸ªç©ºç™½ã€‚æœ€åè€Œå¯¹äºä¸æ˜¯ç©ºç™½èŠ‚ç‚¹çš„ NodeTypes.TEXT èŠ‚ç‚¹ï¼Œç§»é™¤å†…å®¹ä¸­çš„ç©ºç™½ã€‚</p> <p>å¦‚æœå¯¹äº context.inPre ä¸º true ï¼Œè€Œçˆ¶çº§å°±æ˜¯ pre å…ƒç´ çš„ï¼Œç§»é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ¢è¡Œç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªå…³å¿ƒ pre ä¸‹é¢ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å¼€å¤´ä¸èƒ½æ˜¯æ¢è¡Œç¬¦ï¼Œå­™å­èŠ‚ç‚¹ä¸åœ¨åœ¨ä¹ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Whitespace management for more efficient output</span>
  <span class="token comment">// (same as v2 whitespace: 'condense')</span>
  <span class="token keyword">let</span> removedWhitespace <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!==</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inPre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/[^\t\r\n\f ]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> prev <span class="token operator">=</span> nodes<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">const</span> next <span class="token operator">=</span> nodes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment">// If:</span>
            <span class="token comment">// - the whitespace is the first or last node, or:</span>
            <span class="token comment">// - the whitespace is adjacent to a comment, or:</span>
            <span class="token comment">// - the whitespace is between two elements AND contains newline</span>
            <span class="token comment">// Then the whitespace is ignored.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
              <span class="token operator">!</span>prev <span class="token operator">||</span>
              <span class="token operator">!</span>next <span class="token operator">||</span>
              prev<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span> <span class="token operator">||</span>
              next<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span> <span class="token operator">||</span>
              <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">&amp;&amp;</span>
                next<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">&amp;&amp;</span>
                <span class="token regex">/[\r\n]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              removedWhitespace <span class="token operator">=</span> <span class="token boolean">true</span>
              nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token keyword">as</span> any
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// Otherwise, condensed consecutive whitespace inside the text down to</span>
              <span class="token comment">// a single space</span>
              node<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token string">' '</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>content <span class="token operator">=</span> node<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\t\r\n\f ]+/g</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">isPreTag</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// remove leading newline per html spec</span>
      <span class="token comment">// https://html.spec.whatwg.org/multipage/grouping-content.html#the-pre-element</span>
      <span class="token keyword">const</span> first <span class="token operator">=</span> nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">&amp;&amp;</span> first<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        first<span class="token punctuation">.</span>content <span class="token operator">=</span> first<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^\r?\n/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> removedWhitespace <span class="token operator">?</span> nodes<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> <span class="token operator">:</span> nodes

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>è¡¥å……è¯´ä¸€ç‚¹ï¼Œçœ‹çœ‹ä¸‹é¢ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œä¸ºä»€ä¹ˆç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è¦ç§»é™¤ç©ºç™½èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªä¸ç”¨å‘¢ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªç”¨ä¾‹çš„ç©ºç™½èŠ‚ç‚¹æ˜¯è·Ÿ span åŒçº§çš„ï¼Œç§»é™¤ç¬¬ä¸€ä¸ªå’Œæœ€åç©ºç™½èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªç”¨ä¾‹ä¸­çš„ç©ºç™½èŠ‚ç‚¹ï¼Œå±äºåŒçº§å…ƒç´ é—´çš„ç©ºç™½èŠ‚ç‚¹ä¸”æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œæ‰€ä»¥ä¸éœ€è¦ç§»é™¤ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should remove whitespaces at start/end inside an element'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;   &lt;span/&gt;    &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> ElementNode<span class="token punctuation">)</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should NOT remove whitespaces w/o newline between elements'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div/&gt; &lt;div/&gt; &lt;div/&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>é•¿å‘¼ä¸€å£æ°”ï¼Œparse æ¨¡å—ç»ˆäºè®²å®Œäº†ã€‚åªè¦æ˜¯çŸ¥é“é‡Œé¢ parseChildren æ˜¯ä¸ªåµŒå¥—è°ƒç”¨çš„è¿‡ç¨‹ï¼Œé‡Œé¢è¿˜è¦è¿›è¡Œä¸€å®šçš„å®¹é”™ï¼ŒåŒæ—¶ ns å’Œ mode ä¼šå½±å“è§£æï¼Œæ‰“å®Œæ”¶å·¥ã€‚</p> <p>ä¸‡ä¸‡æ²¡æƒ³åˆ°ï¼Œè¿˜æ²¡æœ‰ï¼Œæˆ‘ç«Ÿç„¶å¿˜è®°æœ€åˆçš„æ¢¦æƒ³äº† <code>baseParse</code>ã€‚ æœ€åˆæˆ‘ä»¬æ˜¯åœ¨ createParserContext åˆ›å»ºè§£æä¸Šä¸‹æ–‡ context ï¼Œç„¶åä¿å­˜å¼€å§‹çš„ä½ç½® startï¼Œæ¥ç€ä½¿ç”¨ createRoot å»åˆ›å»º AST çš„ ROOT æ ¹èŠ‚ç‚¹ï¼Œæœ€åè¿”å›è¿™ä¸ªæ ¹èŠ‚ç‚¹ã€‚</p> <p>æˆ‘ä»¬çœ‹çœ‹ createRoot è¿™ä¸ªæ–¹æ³•ï¼Œchildren å°±æ˜¯æˆ‘ä»¬å‰é¢ç”¨ parseChildren è§£æçš„ AST èŠ‚ç‚¹ï¼Œå³ baseParse æœ€ä¸Šå±‚èŠ‚ç‚¹æ˜¯ NodeTypes.ROOTï¼Œå¯¹äº root èŠ‚ç‚¹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ç†è§£ typeã€ childrenã€ loc ï¼Œå› ä¸ºå…¶ä»–å±æ€§éƒ½æ˜¯åœ¨ transform æ—¶å€™èµ‹å€¼è¿›å»çš„ï¼Œä¸ºäº† codegen ã€runtime ç­‰æ—¶å€™èµ·åˆ°å…³é”®ä½œç”¨ã€‚ okï¼Œè¿™æ¬¡ parse çœŸçš„è®²å®Œäº†ï¼Œåé¢å¼€å§‹è®² transformã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>
  <span class="token parameter">content<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> ParserOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>
    <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>
  <span class="token parameter">children<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  loc <span class="token operator">=</span> locStub</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootNode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
    helpers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    hoists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    cached<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    temps<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    loc
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/slamdunk-the-vue3/main/vue/compiler/compiler.html" class="prev">
        compiler
      </a></span> <span class="next"><a href="/slamdunk-the-vue3/main/vue/compiler/transform.html">
        transform(å‡†å¤‡å¼€å§‹æ–½å·¥ğŸš§)
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/slamdunk-the-vue3/assets/js/app.fa9660a2.js" defer></script><script src="/slamdunk-the-vue3/assets/js/2.43eface2.js" defer></script><script src="/slamdunk-the-vue3/assets/js/12.226cd84d.js" defer></script>
  </body>
</html>
